---
import { sanitizeAndDecodeHtml } from '@utils/htmlUtils';
import { marked } from 'marked';
interface Props {
    columns: string[];
    data: string[][];
    align?: 'left' | 'center' | 'right';
    caption?: string;
}

const { columns, data, align = 'left', caption } = Astro.props as Props;

// data å†…ã®ãã‚Œãã‚Œã®ãƒ¬ã‚³ãƒ¼ãƒ‰(è¦ç´ ã§ã‚ã‚‹)ã®é…åˆ—ã®è¦ç´ æ•° ã¨ column ã®è¦ç´ æ•°ãŒä¸€è‡´ã™ã‚‹ã‹ç¢ºèªã™ã‚‹å‡¦ç†ã‚’å…¥ã‚Œã‚‹
// ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼: å„è¡Œã®è¦ç´ æ•°ãŒåˆ—ã®æ•°ã¨ä¸€è‡´ã™ã‚‹ã‹
const isValid = data.every(row => row.length === columns.length);

if (!isValid) {
    throw new Error('Each row in data must have the same number of elements as columns.');
}

columns.forEach((cell, i) => {
    const parsed = marked.parse(cell) as string;
    columns[i] = parsed
        .replace(/^\s*<p>\s*/gm, '') // é–‹å§‹ã® <p> ã‚¿ã‚°ã‚’å‰Šé™¤
        .replace(/\s*<\/p>\s*$/gm, '') // çµ‚äº†ã® </p> ã‚¿ã‚°ã‚’å‰Šé™¤
        .trim(); // ä½™åˆ†ãªç©ºç™½ã‚’å‰Šé™¤
});

data.forEach((row, i) => {
    row.forEach((cell, j) => {
        const parsed = marked.parse(cell) as string;
        data[i][j] = parsed
            .replace(/^\s*<p>\s*/gm, '') // é–‹å§‹ã® <p> ã‚¿ã‚°ã‚’å‰Šé™¤
            .replace(/\s*<\/p>\s*$/gm, '') // çµ‚äº†ã® </p> ã‚¿ã‚°ã‚’å‰Šé™¤
            .trim(); // ä½™åˆ†ãªç©ºç™½ã‚’å‰Šé™¤
    });
});

let parsedCaption = '';
if (caption) {
    parsedCaption = marked.parse(caption) as string;
    parsedCaption
        .replace(/^\s*<p>\s*/gm, '') // é–‹å§‹ã® <p> ã‚¿ã‚°ã‚’å‰Šé™¤
        .replace(/\s*<\/p>\s*$/gm, '') // çµ‚äº†ã® </p> ã‚¿ã‚°ã‚’å‰Šé™¤
        .trim(); // ä½™åˆ†ãªç©ºç™½ã‚’å‰Šé™¤
}

// data.map(row => row.map(cell => console.log(sanitizeAndDecodeHtml(cell))));
---
<!-- <div class=""> -->
<div class="not-content">
    <!-- not-content ã§ width: 100% ã‚’æœ‰åŠ¹åŒ–ã§ãã‚‹ -->
    <table class="
        w-full
        overflow-auto
        text-base
        border-spacing-0
        border-collapse
        border
        border-transparent
        rounded-md
        shadow-sbump
        "
        style={{
            // height: '240px',
            // boxShadow: 'var(--inset-shadow)',
            textAlign: align
        }}

    >
        {typeof caption === 'string' &&
            <caption
                set:html={sanitizeAndDecodeHtml(parsedCaption)}
                class="caption-top py-2"
            />
        }
        <thead class="">
        <!-- <thead class="after:content-[''] after:p-1"> -->
            <tr
                class=""
            >
                {columns.map((column, index) => (
                    <th
                        set:html={sanitizeAndDecodeHtml(column)}
                        is:raw
                        class={`
                            text-white
                            px-2
                            py-1
                            bg-gray-600/50

                            border-spacing-0.5
                            first:rounded-tl-md
                            last:rounded-tr-md
                            shadow-xs-distinct
                        `}
                        style="
                            text-shadow: var(--text-shadow);
                        "
                    />
                ))}
            </tr>
        </thead>
        <tbody>
            {data.map((row, rowIndex) => (
                <tr class="
                    hover:bg-accent-800
                    hover:text-white
                    last:rounded-bl-md
                    last:rounded-br-md
                ">
                    {row.map((cell, cellIndex) => (
                        <td
                            set:html={sanitizeAndDecodeHtml(cell)}
                            class={`
                                p-2
                                border
                                border-gray-500
                                first:border-l-0
                                shadow-xs-depressed
                                ${rowIndex === data.length - 1 && cellIndex === 0 ? 'rounded-bl-md' : ''}
                                ${rowIndex === data.length - 1 && cellIndex === row.length - 1 ? 'rounded-br-md' : ''}
                            `}
                        />
                    ))}
                </tr>
            ))}
        </tbody>
    </table>

    <!-- <h1 class="after:content-['ğŸ‘‹ğŸ¼']">
  Hello world!
</h1> -->

</div>
