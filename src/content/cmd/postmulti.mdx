---
# layout: ../../../layouts/MarkdownPostLayout.astro
title: "postmulti"
description: "ファイル閲覧を目的に利用するが、ファイルのテキストを出力する働きで、オプションによって複数のテキストを結合して標準出力を行う"
image:
    url: "https://docs.astro.build/assets/full-logo-light.png"
    alt: "Astroのロゴ。"
tags:
    - "メール管理"
featured: false
draft: true
author: "Astro学習者"
pubDatetime: 2024-10-27T21:39:29.000+09:00
modDatetime: 2024-10-27T21:39:29.000+09:00
---

## 参考

[水銀室 Postfix をマルチインスタンスで起動する -CentOS 最短構築支援-](https://hp.vector.co.jp/authors/VA022911/tec/centos/postfix_multi_instance.htm)

[postmulti -
マニュアルページ セク ション 1: ユー ザーコマンド](https://docs.oracle.com/cd/E62101_01/html/E62874/postmulti-1.html)

[Postfix のマルチインスタンス (multi-instance)構成についてメモ - Qiita](https://qiita.com/amedama/items/79c8e4e0714e1676e99b)

## 基本

### 説明

Postfix マルチインスタンスの管理ツール

`postmulti`コマンドは、Postfix 管理者が一つのホスト上で複数の Postfix インスタンスを管理することを可能にします。

-   iterator mode …複数の Postfix インスタンスに対して同じコマンドを実行する
-   life-cycle management mode …一つのインスタンスを追加・削除・状態を変更したりします。

それぞれの動作モードには独自のコマンド構文があります。このため、それぞれのモードについて、以下に別々のセクションで説明します。

### 構文

> Enabling multi-instance management (マルチインスタンス管理の有効化)

```bash
postmulti -e init [-v]
```

> Iterator mode

```bash
postmulti -l [-aRv] [-g group] [-i name]

postmulti -p [-av] [-g group] [-i name] postfix-command...

postmulti -x [-aRv] [-g group] [-i name] unix-command...
```

> Life-cycle management mode

```bash
postmulti -e create [-av] [-g group] [-i name] [-G group] [-I name] [param=value ...]

postmulti -e import [-av] [-g group] [-i name] [-G group] [-I name] [config_directory=/path]

postmulti -e destroy [-v] -i name

postmulti -e deport [-v] -i name

postmulti -e enable [-v] -i name

postmulti -e disable [-v] -i name

postmulti -e assign [-v] -i name [-I name] [-G group]
```

### 背景

マルチインスタンス構成は、1 つのプライマリ Postfix インスタンスと、1 つ以上のセカンダリインスタンスから構成され、セカンダリインスタンスの設定ディレクトリのパスはプライマリインスタンスの `main.cf` ファイルに記録されます。
Postfix インスタンスはプログラムファイルやドキュメントを共有しますが、各インスタンスは独自の設定、キュー、データディレクトリを持ちます。

現在、デフォルトの Postfix インスタンスのみがマルチインスタンス構成においてプライマリインスタンスとして使用可能です。
`postmulti(1)` コマンドは、代替のプライマリインスタンスを選択するための `-c` オプションをサポートしておらず、`MAIL_CONFIG` 環境変数にデフォルトでない設定ディレクトリが設定されている場合は致命的なエラーを出して終了します。

マルチインスタンスの管理についての詳細は、`MULTI_INSTANCE_README` チュートリアルを参照してください。

## オプション

### ITERATOR MODE

`postmulti` はすべての Postfix インスタンスに対して順番に同じ操作を実行します。

マルチインスタンスサポートが有効でない場合、指定されたコマンドはプライマリインスタンスのみに対して実行されます。

イテレーターモードでは以下のコマンドオプションが使用できます：

インスタンスの選択

| オプション | 説明                                                                 |
| ---------- | -------------------------------------------------------------------- |
| -a         | すべてのインスタンスに対して操作を実行します。これはデフォルトの動作 |
| -g group   | 指定された group のメンバーに対してのみ操作を実行                    |
| -i name    | 指定された name のインスタンスに対してのみ操作を実行します。         |

インスタンス名またはインスタンスの設定ディレクトリの絶対パスを指定できます。
name に `-` を指定するとプライマリ Postfix インスタンスが選択されます |
| -R | イテレーションの順序を逆にします(Revert)。
これは「シンク」インスタンスを「ソース」インスタンスよりも先に開始するようなマルチインスタンスシステムの更新時に適しています
このオプションは `-p` と一緒に使用することはできません |

<aside>
<img src="/icons/info-alternate_blue.svg" alt="/icons/info-alternate_blue.svg" width="40px" />

summary
イテレーターモードでは、複数の Postfix インスタンスに対して同じ操作を連続して実行する際に便利です。
`-a` を使うとすべてのインスタンスに、`-g` で特定のグループ内のインスタンスに、`-i` で特定のインスタンスのみに操作を実行します。
また、`-R` を使うことで、処理の順序を逆にすることも可能です。

</aside>

### List mode

| オプション                                                                                        | 説明                     |
| ------------------------------------------------------------------------------------------------- | ------------------------ |
| -l                                                                                                | インスタンスリストの表示 |
| インスタンス名、グループ名、enable/disable の状態、設定ファイルディレクトリなどの情報が表示される |

### Postfix-wrapper mode

Postfix-wrapper mode は、postmulti がラッパーとして postfix コマンドを実行する際に使用されます。このモードでは、特定のインスタンスやグループに対して start、stop、reload などの操作を行うことができ、postmulti のパラメータでコマンドをカスタマイズ可能です。

```bash
-p *postfix-command*
```

`postfix(1)` を呼び出して `postfix-command` を実行します。このオプションは `postfix-wrapper(5)` インターフェースを実装します。

-   「start」系のコマンドの場合、有効化されていないインスタンスに対して "postfix check" が実行されます。コマンドの完全なリストは `postmulti_start_commands` パラメータで指定されます。
-   「stop」系のコマンドの場合、イテレーションの順序が逆になり、無効化されているインスタンスはスキップされます。コマンドの完全なリストは `postmulti_stop_commands` パラメータで指定されます。
-   「reload」や開始済みのインスタンスを必要とするその他のコマンドの場合、無効化されているインスタンスはスキップされます。コマンドの完全なリストは `postmulti_control_commands` パラメータで指定されます。
-   「status」や、開始済みのインスタンスを必要としない他のコマンドの場合、すべてのインスタンスに対してコマンドが実行されます。

`-p` オプションは、指定されたインスタンスやインスタンスグループをインタラクティブに開始/停止するためにも使用できます。
たとえば、"msa" グループ内のインスタンスだけを開始するには、以下のように `postmulti(1)` を実行します：

```bash
postmulti -g msa -p start
```

### Command mode

```bash
-x unix-command
```

すべての Postfix インスタンスに対して指定された `unix-command` を実行します。
このコマンドは、`MAIL_CONFIG`、`command_directory`、`daemon_directory`、`config_directory`、`queue_directory`、`data_directory`、`multi_instance_name`、`multi_instance_group`、および `multi_instance_enable` に適切な環境設定がされた状態で実行されます。

### Other options

-v Enable verbose logging for debugging purposes. Multiple -v options make the software increasingly verbose.

## LIFE-CYCLE MANAGEMENT MODE

`-e` オプションを使用することで、`postmulti(1)` を用いて Postfix インスタンスを追加または削除したり、既存のインスタンスのマルチインスタンスステータスを管理できます。

### Existing instance selection

| オプション | 説明                                                                                                                             |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------- |
| -a         | インスタンスを作成またはインポートする際に、新しいインスタンスをセカンダリインスタンスリストの先頭に配置します                   |
| -g group   | インスタンスを作成またはインポートする際に、指定したグループの最初のセカンダリインスタンスの前に新しいインスタンスを配置します。 |

|
| -i name | インスタンスを作成またはインポートする際に、一致するセカンダリインスタンスの前に新しいインスタンスを配置します。

他のライフサイクル操作の場合、指定した既存インスタンスに対して操作を適用します。プライマリ Postfix インスタンスを選択するには、"-" を指定します |

### New or existing instance name assignment

```bash
-I name
              Assign the specified instance name to an existing instance, newly-created instance, or imported instance.  Instance names other than "-" (which makes the instance "nameless") must start
              with "postfix-".  This restriction reduces the likelihood of name collisions with system files.

-G group
              Assign the specified group name to an existing instance or to a newly created or imported instance.
```

### Instance creation/deletion/status change

管理対象インスタンスを「編集」する

```bash
postmulti -e action
```

| action | 説明                                                                           |
| ------ | ------------------------------------------------------------------------------ |
| init   | `postmulti`を用いて Postfix インスタンスを管理する前にこのコマンドが必要です。 |

`postmulti -e init` コマンドは、以下の設定をプライマリインスタンスの main.cf ファイルに追加して更新します：

```
multi_instance_wrapper = ${command_directory}/postmulti -p --
multi_instance_enable = yes
```

これらの設定は、他の方法でも設定可能です。 |
| create | 新しい Postfix インスタンスを作成し、プライマリインスタンスの multi_instance_directories パラメータに追加します。
インスタンスに短い名前を付ける `-I name`オプションの使用が推奨されます。これにより、新インスタンスのプライベートディレクトリのデフォルト値が構築されます。`-G group` オプションでグループに割り当てることも可能です。
新しいインスタンスの main.cf は基本の main.cf で、共有ファイルの場所を指定するパラメータがプライマリインスタンスからコピーされます。「名前なし」のインスタンスの場合、`syslog_name` を手動で調整し、ログ内でインスタンスを識別できるようにします。`-I name` オプションで名前を割り当てる方が簡単です。

オプションの "name=value" 引数で `config_directory`、`queue_directory`、および `data_directory` を指定できます。例：
postmulti -I postfix-mumble \
 -G mygroup -e create \
 config_directory=/my/config/dir \
 queue_directory=/my/queue/dir \
 data_directory=/my/data/dir

これらのパスが指定されない場合は、プライマリインスタンスのパスの最後の要素を `-I` オプションの値に置き換えたパスを生成します。

インスタンスの設定ディレクトリが既に存在し、main.cf および master.cf ファイルを含む場合、`create` コマンドはそのインスタンスを「そのままインポート」します。既存のインスタンスの場合、`create` と `import` は同じ意味になります。
|
| import | 既存のインスタンスを postmulti(1) のマルチインスタンス管理対象にインポートします。これにより、インスタンスがプライマリインスタンスの multi_instance_directories リストに追加されます。
`-I name` オプションが指定されている場合、新しいインスタンス名として機能し、インスタンス設定ディレクトリのデフォルトの場所が定義されます（上記 `create` と同様）。
`-G group` オプションでグループに割り当てることが可能です。
"config_directory=/path" 引数を追加して、`-I name` ベースのデフォルトパス名をオーバーライドできます。 |
| destroy | セカンダリ Postfix インスタンスを削除します。
削除対象となるインスタンスは、
・無効化されていて停止している
・キューにメッセージがない状態
プライマリ Postfix インスタンスを削除しようとすると致命的なエラーが発生し、削除されません。

インスタンスはプライマリインスタンスの main.cf ファイルの `alternate_config_directories` パラメータから削除され、そのデータ、キュー、設定ディレクトリが Postfix システムによって作成されたファイルやディレクトリからクリーンアップされます。
main.cf および master.cf ファイルは初期作成以降に変更があっても設定ディレクトリから削除されます。
最後に、インスタンスは管理対象インスタンスリストから「削除」されます。

インスタンスのプライベートディレクトリに他のファイルが存在する場合、完全に削除されない可能性があり、管理者に警告がログに記録されます。
ディレクトリが「新しい」ものとして `create` アクションで作成されたインスタンスは、`disable` 後に `destroy` アクションで完全に削除されることが期待されます。
設定やキューディレクトリにアクセスや書き換えテーブル、chroot 環境コンテンツなどの追加ファイルがある場合、インスタンスディレクトリは完全に削除されません。

`destroy` アクションは、潜在的に危険なファイル削除操作を引き起こすため、インスタンスの `data`、`queue`、および `config` ディレクトリが正しく設定されており、貴重なファイルが含まれていないことを確認してください。
|
| deport | セカンダリインスタンスを管理対象インスタンスリストから削除します。これにより、インスタンス設定ディレクトリがプライマリインスタンスの multi_instance_directories リストから削除されますが、ファイルやディレクトリは削除されません。 |
| assign | インスタンスに新しい名前またはグループ名を割り当てます。`-G -` で「グループなし」、`-I -` で「名前なし」を指定できます。インスタンスを「名前なし」にする場合、対応する main.cf ファイルで適切な `syslog_name` を設定してください。 |
| enable | 選択されたインスタンスを有効化としてマークします。これは、インスタンスの main.cf ファイル内で `multi_instance_enable` パラメータを "yes" に設定するだけです。 |
| disable | 選択されたインスタンスを無効化としてマークします。これにより、"postfix start"、"postmulti -p start" などでインスタンスが開始されなくなります。インスタンスは、"postfix -c config-directory start" などで引き続き開始可能です。 |

### Other options

```bash
-v     Enable verbose logging for debugging purposes. Multiple -v options make the software increasingly verbose.
```

## オプション

### オプションリスト

### -○ オプション

> **使い方**

```bash
使用コマンド例
```

## 応用例

### 応用 1

```bash
postmulti -I postfix-xxx -e create
```

-   `/etc/postfix-xxx`ディレクトリが作成され、中に子インスタンスの [main.cf](http://main.cf) と [master.cf](http://master.cf) が生成される。
-   ディレクトリ`/var/spool/postfix-sub`や`/var/lib/postfix-sub` が生成され、アクセス権が設定される

### インスタンスの自動起動設定について

```bash
postmulti -i postfix-xxx -e enable # システムの起動後も自動でインスタンスが起動することを有効化
postmulti -i postfix-xxx -e disable # システムの起動後も自動でインスタンスが起動することを無効化
```

```bash
postmulti -l
-               -               y         /etc/postfix
postfix-es5     -               y         /etc/postfix-es5
postfix-zqt     -               y         /etc/postfix-zqt
postfix-sap     -               y         /etc/postfix-sap
postfix-tr3     -               y         /etc/postfix-tr3

postmulti -i postfix-zqt -e disable
postmulti -l
-               -               y         /etc/postfix
postfix-es5     -               y         /etc/postfix-es5
postfix-zqt     -               n         /etc/postfix-zqt
postfix-sap     -               y         /etc/postfix-sap
postfix-tr3     -               y         /etc/postfix-tr3
```

```bash
postmulti -i postfix-xxx -p start # インスタンスの稼働
postmulti -i postfix-xxx -p status # インスタンスの状態確認
postmulti -i postfix-xxx -p stop # インスタンスの停止
```

### セカンダリインスタンスの状態確認

```bash
SECONDARY_COUNT=$(postmulti -l | grep -c postfix-)
# マルチインスタンスの状態確認
for i in $(seq 1 "$SECONDARY_COUNT"); do
    postmulti -i postfix-"$i" -p status
done

```

### マルチインスタンスの安全な削除

```bash

SECONDARY_COUNT=$(postmulti -l | grep -c postfix-)
echo "$SECONDARY_COUNT"
# マルチインスタンスの状態確認
for i in $(seq 1 "$SECONDARY_COUNT"); do
		echo "postfix-$i を削除"
    postmulti -i postfix-"$i" -p stop
    postmulti -i postfix-"$i" -e disable
    postmulti -i postfix-"$i" -p status
    rm -rf /var/spool/postfix-"$i"
    postmulti -i postfix-"$i" -e destroy
done

for i in $(seq 65 74); do
		echo "postfix-$i を削除"
    postmulti -i postfix-"$i" -p stop
    postmulti -i postfix-"$i" -e disable
    postmulti -i postfix-"$i" -p status
    rm -rf /var/spool/postfix-"$i"
    postmulti -i postfix-"$i" -e destroy
done
```

## ENVIRONMENT

```bash
The postmulti(1) command exports the following environment variables before executing the requested command for a given instance:

MAIL_VERBOSE
This is set when the -v command-line option is present.

MAIL_CONFIGThe location of the configuration directory of the instance.
```

## シナリオ

[無題](https://www.notion.so/12fc6d8c64d0805eb211e0a22903da56?pvs=21)

## CONFIGURATION PARAMETERS

```bash
config_directory (see 'postconf -d' output)
              The default location of the Postfix main.cf and master.cf configuration files.

daemon_directory (see 'postconf -d' output)
              The directory with Postfix support programs and daemon programs.

import_environment (see 'postconf -d' output)
              The list of environment parameters that a privileged Postfix process will import from a non-Postfix parent process, or name=value environment overrides.

multi_instance_directories (empty)
              An  optional  list  of  non-default Postfix configuration directories; these directories belong to additional Postfix instances that share the Postfix executable files and documentation
              with the default Postfix instance, and that are started, stopped, etc., together with the default Postfix instance.

multi_instance_group (empty)
              The optional instance group name of this Postfix instance.

multi_instance_name (empty)
              The optional instance name of this Postfix instance.

multi_instance_enable (no)
              Allow this Postfix instance to be started, stopped, etc., by a multi-instance manager.

postmulti_start_commands (start)
              The postfix(1) commands that the postmulti(1) instance manager treats as "start" commands.

postmulti_stop_commands (see 'postconf -d' output)
              The postfix(1) commands that the postmulti(1) instance manager treats as "stop" commands.

postmulti_control_commands (reload flush)
              The postfix(1) commands that the postmulti(1) instance manager treats as "control" commands, that operate on running instances.

syslog_facility (mail)
              The syslog facility of Postfix logging.

syslog_name (see 'postconf -d' output)
              A prefix that is prepended to the process name in syslog records, so that, for example, "smtpd" becomes "prefix/smtpd".

Available in Postfix 3.0 and later:

meta_directory (see 'postconf -d' output)
              The location of non-executable files that are shared among multiple Postfix instances, such as postfix-files, dynamicmaps.cf, and the multi-instance  template  files  main.cf.proto  and
              master.cf.proto.

shlib_directory (see 'postconf -d' output)
              The  location  of Postfix dynamically-linked libraries (libpostfix-*.so), and the default location of Postfix database plugins (postfix-*.so) that have a relative pathname in the dynam-
              icmaps.cf file.
```

### その他

> **FILES**

```bash
$meta_directory/main.cf.proto, stock configuration file
$meta_directory/master.cf.proto, stock configuration file
$daemon_directory/postmulti-script, life-cycle helper program
```

> **AUTHORS**

Victor Duchovni
Morgan Stanley

Wietse Venema
IBM T.J. Watson Research
P.O. Box 704
Yorktown Heights, NY 10598, USA

Wietse Venema
Google, Inc.
111 8th Avenue
New York, NY 10011, USA

> **SEE ALSO**

postfix(1), Postfix control program
postfix-wrapper(5), Postfix multi-instance API

> **README FILES**

Use "postconf readme_directory" or "postconf html_directory" to locate this information.
MULTI_INSTANCE_README, Postfix multi-instance management

> **HISTORY**

The postmulti(1) command was introduced with Postfix version 2.6.

> **LICENSE**

The Secure Mailer license must be distributed with this software.
