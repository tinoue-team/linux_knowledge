---
# layout: ../../../layouts/MarkdownPostLayout.astro
title: 'ls'
pubDate: 2022-07-01
description: 'netfilter を管理するインターフェースの提供'
image:
    url: 'https://docs.astro.build/assets/full-logo-light.png'
    alt: 'Astroのロゴ。'
tags:
  - "ネットワーク管理"
featured: false
draft: true
author: 'Astro学習者'
pubDatetime: 2024-10-27T21:39:29.000+09:00
modDatetime: 2024-10-27T21:39:29.000+09:00
---

## 基本

### 説明

このプログラムは Linux ファイアウォールを管理するためのもので、ユーザーに使いやすいインターフェースを提供することを目的としている。

### 構文

```bash
ufw [--dry-run] enable|disable|reload
ufw [--dry-run] default allow|deny|reject [incoming|outgoing|routed]
ufw [--dry-run] logging on|off|LEVEL
ufw [--dry-run] reset
ufw [--dry-run] status [verbose|numbered]
ufw [--dry-run] show REPORT
ufw [--dry-run]  [delete]  [insert NUM] [prepend] allow|deny|reject|limit [in|out] [log|log-all] [ PORT[/PROTOCOL] | APPNAME ] [comment COMMENT]
ufw [--dry-run] [rule] [delete] [insert NUM] [prepend] allow|deny|reject|limit [in|out [on INTERFACE]]  [log|log-all]  [proto  PROTOCOL] [from ADDRESS [port PORT | app APPNAME ]] [to ADDRESS [port PORT | app APPNAME ]] [comment COMMENT]
ufw [--dry-run] route [delete] [insert NUM] [prepend] allow|deny|reject|limit [in|out on INTERFACE] [log|log-all] [proto PROTOCOL] [from ADDRESS [port PORT | app APPNAME]] [to ADDRESS [port PORT | app APPNAME]] [comment COMMENT]
ufw [--dry-run] [--force] delete NUM
ufw [--dry-run] app list|info|default|update
```

## オプション

### オプションリスト

| オプション | 説明 |
| --- | --- |
| `--version` | プログラムのバージョン番号を表示して終了します。 |
| `-h`, `--help` | ヘルプメッセージを表示して終了します。 |
| `--dry-run` | 何も変更せず、変更内容のみを表示します。 |
| `enable` | ファイアウォールを再読み込みし、起動時にファイアウォールを有効にします。 |
| `disable` | ファイアウォールをアンロードし、起動時にファイアウォールを無効にします。 |
| `reload` | ファイアウォールを再読み込みします。 |
| `default [allow \| deny \| reject] DIRECTION` | DIRECTION（DIRECTIONはincoming、outgoing、routedのいずれか）へ向かうトラフィックのデフォルトポリシーを変更します。デフォルトポリシーを変更する場合、既存のルールを手動で移行する必要があることに注意してください。denyとrejectの詳細については、RULE SYNTAXを参照のこと。 |
| `logging [on \| off \| LEVEL]`  | ロギングを切り替える。 ログに記録されるパケットは、LOG_KERN syslogファシリティを使う。 rsyslog サポート用に設定されたシステムは、/var/log/ufw.logにログを記録することもできる。LEVELを指定すると、指定されたLEVELのログがオンになる。デフォルトのログレベルは「low」である。 詳細は LOGGING を参照してください。 |
| `reset` | ファイアウォールを無効にし、インストール時のデフォルト設定にリセットします。`--force` オプションを指定すると、確認なしでリセットを実行できます。 |
| `status` | ファイアウォールと `ufw` が管理するルールのステータスを表示します。 |
| `show REPORT` | 実行中のファイアウォールに関する情報を表示します。REPORTS を参照してください。 |
| `allow ARGS` | 許可ルールを追加します。RULE SYNTAX を参照してください。 |
| `deny ARGS` | 拒否ルールを追加します。RULE SYNTAX を参照してください。 |
| `reject ARGS` | リジェクトルールを追加します。RULE SYNTAX を参照してください。 |
| `limit ARGS` | 制限ルールを追加します。RULE SYNTAX を参照してください。 |
| `delete RULE \| NUM` | 対応する RULE を削除 |
| `insert NUM RULE` | 対応する RULE をルール番号 `NUM` として挿入します。 |
| `prepend RULE` | 対応する RULE をルールセットの先頭に追加します。 |

### status

`status verbose` を使用すると、追加情報が表示されます。

ステータス出力では、`Anywhere` は `any`, `0.0.0.0/0` (IPv4) および `::/0` (IPv6) と同義です。`status` を使用する際、インターフェースの報告には微妙な違いがあります。

例えば、以下のルールを追加すると：

```bash
ufw allow in on eth0 from 192.168.0.0/16
ufw allow out on eth1 to 10.0.0.0/8
ufw route allow in on eth0 out on eth1 to 10.0.0.0/8 from 192.168.0.0/16
ufw limit 2222/tcp comment 'SSH port'
```

`ufw status` は以下のように出力します:

```bash
To                         Action      From
--                         ------      ----
Anywhere on eth0           ALLOW       192.168.0.0/16
10.0.0.0/8                 ALLOW OUT   Anywhere on eth1
10.0.0.0/8 on eth1         ALLOW FWD   192.168.0.0/16 on eth0
Anywhere                   LIMIT       Anywhere                 # SSH port
```

入力および出力ルールでは、インターフェースはファイアウォールシステムのエンドポイントに対して報告されますが、ルートルールでは、パケットがファイアウォールを通過する方向に対して報告されます。

---

### **補足情報**

- **DIRECTION の説明**:
  - `incoming`: 入ってくるトラフィック
  - `outgoing`: 出ていくトラフィック
  - `routed`: ルーティングされるトラフィック
- **RULE SYNTAX について**:
  - `deny` はトラフィックを拒否しますが、`reject` はトラフィックを拒否しつつ、送信元に通知を返します。
- **ログレベル (`LEVEL`) の例**:
  - `low`, `medium`, `high`, `full`

---

### **使用例**

1. **ファイアウォールのバージョン確認**:

    ```bash
    sudo ufw --version
    ```

2. **ヘルプメッセージの表示**:

    ```bash
    sudo ufw --help
    ```

3. **ファイアウォールの有効化**:

    ```bash
    sudo ufw enable
    ```

4. **特定のポート（例: SSHポート22）の許可**:

    ```bash
    sudo ufw allow 22/tcp
    ```

5. **ファイアウォールのステータス確認**:

    ```bash
    sudo ufw status
    sudo ufw status verbose
    ```

6. **デフォルトポリシーの設定（例: 受信トラフィックを拒否）**:

    ```bash
    sudo ufw default deny incoming
    ```

7. **ロギングの有効化**:

    ```bash
    sudo ufw logging on
    sudo ufw logging high
    ```

8. **ファイアウォールのリセット**:

    ```bash
    sudo ufw reset
    sudo ufw reset --force
    ```

---

**注意事項**：

- ファイアウォールの設定を変更する際は、特にリモートサーバーの場合、接続が遮断されないよう注意してください。必要に応じてコンソールアクセスを確保してください。
- `ufw` の詳細な使用方法や追加オプションについては、公式ドキュメントや `man ufw` を参照してください。

## RULE SYNTAX

### ルール構文

ユーザーは、シンプルな構文またはフル構文のいずれかを使用してルールを指定できます。シンプルな構文では、ホストで許可または拒否するポートと、オプションでプロトコルのみを指定します。

両方の構文では、ルールにコメントを指定することができます。既存のルールに対して異なるコメントを指定するとコメントが更新され、`''` を指定するとコメントが削除されます。

### シンプル構文を使用したルールの例

> **トラフィックの許可・拒否設定**
>

```bash
# ホスト上の任意のアドレスに対して TCP および UDP ポート 53 を許可
ufw allow 53

# プロトコルを指定するには、ポートに '**/<*protocol>**'* を追加
# ホスト上の任意のアドレスに対して TCP ポート 25 を許可
ufw allow 25/tcp

# 上記の処理と同じだがサービス名で指定する場合は
ufw allow <*service*>
# ex.
ufw allow smtp
```

<aside>
<img src="/icons/info-alternate_blue.svg" alt="/icons/info-alternate_blue.svg" width="40px" />

サービス名で指定する場合、`ufw` は `/etc/services` をチェックします。

</aside>

`ufw` は受信（ingress）および送信（egress）のフィルタリングの両方をサポートしており、ユーザーはオプションでトラフィックの方向を `in` または `out` のいずれかで指定できます。方向が指定されていない場合(default)、ルールは受信トラフィックに適用されます。

例：

```bash
ufw allow in http
ufw reject out smtp
ufw reject telnet comment 'telnet is unencrypted'

```

ユーザーは、ソースおよびデスティネーションのアドレスやポートを指定するフル構文も使用できます。
この構文は OpenBSD の PF 構文に大まかに基づいています。例えば：

```bash
# ホスト上の TCP ポート 80 へのすべてのトラフィックを拒否
ufw deny proto tcp to any port 80

# RFC1918 のクラスAネットワークから 192.168.0.1 の TCP ポート 25 へのすべてのトラフィックを拒否
ufw deny proto tcp from 10.0.0.0/8 to 192.168.0.1 port 25

# IPv6 の 2001:db8::/32 からホスト上の TCP ポート 25 へのすべてのトラフィックを拒否
ufw deny proto tcp from 2001:db8::/32 to any port 25
```

<aside>
<img src="/icons/warning_yellow.svg" alt="/icons/warning_yellow.svg" width="40px" />

IPv6 ファイアウォールを機能させるためには、`/etc/default/ufw` で IPv6 を有効にする必要があります。

</aside>

```bash
# eth0 インターフェース上の 224.0.0.1 へのすべての IGMP トラフィックを拒否
ufw deny in on eth0 to 224.0.0.1 proto igmp

# eth0 インターフェース上の 192.168.0.1 へのすべての GRE トラフィックを許可
ufw allow in on eth0 to 192.168.0.1 proto gre
```

```bash
# TCP ポート 80、443、および 8080-8090（両端を含む）へのすべてのトラフィックを許可し、ルールにコメントを追加します
ufw allow proto tcp from any to any port 80,443,8080:8090 comment 'web app'
```

複数のポートを指定する場合、ポートリストは数値でなければならず、スペースを含めることはできず、全体として変更する必要があります。
例えば、上記の例では後で '443' ポートのみを削除しようとすることはできません。また、ポートは 15 個以上指定できません（範囲は 2 ポートとしてカウントされるため、上記の例ではポート数は 4 です）。

`ufw` は複数のプロトコルをサポートしています。以下は、どのルールでも有効で、プロトコルが指定されていない場合に有効になります：

- `tcp`
- `udp`

以下は特定の制限があり、プロトコルが指定されていない場合には有効になりません：

- `ah`　ポート番号なしで有効
- `esp`　ポート番号なしで有効
- `gre`　ポート番号なしで有効
- `ipv6`　IPv4 アドレスおよびポート番号なしで有効
- `igmp`　IPv4 アドレスおよびポート番号なしで有効

ホスト自体を対象とせず、ファイアウォールを通過（ルーティング/フォワーディング）するトラフィックのルールは、ルールの前に `route` キーワードを指定する必要があります（ルーティングルールは PF 構文とは大きく異なり、netfilter の FORWARD チェーンの規約を考慮します）。

例えば：

```bash
# eth1 から eth2 に入ってくるすべてのトラフィックをファイアウォールを通過させることを許可
ufw route allow in on eth1 out on eth2

# eth0 から入ってきて eth1 を通過して 12.34.45.67 の TCP ポート 80 に送信される任意のパケットを許可
ufw route allow in on eth0 out on eth1 to 12.34.45.67 port 80 proto tcp
```

> **IP フォワーディング設定( `sysctl.conf`)**
>

ルーティングルールおよびポリシーに加えて、IP フォワーディングも設定する必要があります。
`/etc/ufw/sysctl.conf` に以下を設定することで行えます：

```bash
net/ipv4/ip_forward=1
net/ipv6/conf/default/forwarding=1
net/ipv6/conf/all/forwarding=1

```

その後、設定を反映させるためにファイアウォールを再起動：

```bash
ufw disable
ufw enable

```

カーネルのチューナブル設定はオペレーティングシステム固有であり、`ufw` の sysctl 設定が上書きされる可能性があることに注意してください。
詳細については、`sysctl` のマニュアルページを参照してください。

`ufw` は接続レート制限をサポートしており、これはブルートフォースログイン攻撃から保護するのに有用です。
制限ルールが使用される場合、`ufw` は通常接続を許可しますが、ある IP アドレスが 30 秒以内に 6 回以上接続を試みた場合、接続を拒否します。
詳細は [Debian Administrationの記事](http://www.debian-administration.org/articles/187) を参照してください。
典型的な使用例は：

```bash
ufw limit ssh/tcp
```

時には、トラフィックが拒否されていることを送信者に知らせることが望ましい場合があります。
このような場合は、単に無視するのではなく `deny` の代わりに `reject` を使用します。
例えば：

```bash
ufw reject auth
```

デフォルトでは、`ufw` はすべての利用可能なインターフェースにルールを適用します。
これを制限するには、`DIRECTION` を `INTERFACE` に指定します。
`DIRECTION` は `in` または `out` のいずれかです（インターフェースエイリアスはサポートされていません）。

例えば、`eth0` 上で新しいすべての受信 HTTP 接続を許可するには、次のようにします：

```bash
ufw allow in on eth0 to any port 80 proto tcp
```

ルールを削除するには、元のルールの前に `delete` を付けます。ルールのコメントがある場合でもない場合でも構いません。
例えば、元のルールが `ufw deny 80/tcp` の場合、これを削除するには：

```bash
ufw delete deny 80/tcp
```

また、`status` の番号付き出力で見られるように、ルール番号 `NUM` を指定してルールを削除することもできます。
例えば、ルール番号 `3` を削除したい場合は：

```bash
ufw delete 3
```

IPv6 が有効になっていて、IPv4 および IPv6 の両方に適用される汎用ルール（例：`ufw allow 22/tcp`）を削除する場合、ルール番号で削除すると指定されたルールのみが削除されます。両方を一度に削除するには、元のルールの前に `delete` を付けます。

ルールを挿入するには、新しいルールを通常通り指定しますが、ルール番号を前に付けて挿入します。例えば、ルールが 4 つあり、新しいルールをルール番号 3 として挿入したい場合は：

```bash
ufw insert 3 deny to any port 22 from 10.0.0.135 proto tcp
```

同様に、ルールの IP タイプに一致するすべての他のルールの前にルールを追加するには、`prepend` ルールを使用します：

```bash
ufw prepend deny from 1.2.3.4
```

これは、動的ファイアウォール（IPS で見られるような）に特に有用です。重要なことに、指定されたルールが IPv4 ルールの場合、すべての他の IPv4 ルールの前に追加されます。IPv6 ルールの場合、すべての IPv6 ルールの前に追加されます。

番号付きルールのリストを表示するには、次のコマンドを使用します：

```bash
ufw status numbered
```

`ufw` はルールごとのログ記録をサポートしています。デフォルトでは、パケットがルールにマッチしたときにログは記録されません。`log` を指定すると、そのルールにマッチするすべての新しい接続がログに記録され、`log-all` を指定すると、そのルールにマッチするすべてのパケットがログに記録されます。例えば、すべての新しい SSH 接続を許可してログに記録するには：

```bash
ufw allow log 22/tcp
```

ログ記録の詳細については、**LOGGING** を参照してください。

---

## 応用例

### EXAMPLES

```bash
# 53番ポートのアクセスをすべて拒否する
ufw deny 53

# 80番ポートの tcp 接続をすべて許可
ufw allow 80/tcp

# RFC1918ネットワークからこのホストへのアクセスをすべて許可
ufw allow from 10.0.0.0/8
ufw allow from 172.16.0.0/12
ufw allow from 192.168.0.0/16
  
# ホスト1.2.3.4 からの udp ポート 514 へのアクセスを拒否
ufw deny proto udp from 1.2.3.4 to any port 514

# udpプロトコル通信の 1.2.3.5:5469 から 1.2.3.4:5469 へのアクセスを許可
ufw allow proto udp from 1.2.3.5 port 5469 to 1.2.3.4 port 5469
```

## リモート管理

`ufw enable` を実行するか、`ufw` をそのinitスクリプト経由で起動する際、`ufw` はチェーンをフラッシュします。これは `ufw` が一貫した状態を維持するために必要ですが、既存の接続（例：SSH）が切断される可能性があります。
`ufw` はファイアウォールを有効化する前にルールを追加することをサポートしているため、管理者は以下のように実行できます：

```bash
ufw allow proto tcp from any to any port 22
```

`ufw enable` を実行する前にこれを行うことで、ルールはフラッシュされますが、ファイアウォールを有効化した後にSSHポートは開放されます。`ufw` が「有効化」された後、ルールを追加または削除する際にはチェーンはフラッシュされません（ただし、ルールの変更やデフォルトポリシーの変更時にはフラッシュされます）。デフォルトでは、SSH経由で実行している場合、ファイアウォールを有効化する際に `ufw` はプロンプトを表示します。これを無効にするには、`ufw --force enable` を使用します。

<aside>
<img src="/icons/warning_yellow.svg" alt="/icons/warning_yellow.svg" width="40px" />

`ufw --force enable` について

`--force` オプションを使用すると、ファイアウォールの有効化時に確認プロンプトが表示されなくなります。これにより、自動化スクリプトなどでの利用が容易になりますが、誤ってファイアウォールを有効化して接続を失うリスクもあるため注意が必要です。

</aside>

---

**補足説明：**

- **チェーンのフラッシュ**:
  - `ufw enable` を実行すると、既存の `iptables` ルールがすべてクリア（フラッシュ）されます。これにより、`ufw` が管理するルールのみが適用され、一貫性が保たれますが、既存の接続が一時的に遮断される可能性があります。
- **事前のルール追加**:
  - ファイアウォールを有効化する前に必要なルール（例：SSHポートの許可）を追加しておくことで、`ufw enable` 実行後も指定したポートが開放された状態を維持できます。
- **ルールの追加・削除時の挙動**:
  - `ufw` が有効化された後は、ルールの追加や削除時にチェーンがフラッシュされないため、既存の接続が維持されやすくなります。ただし、ルールの変更やデフォルトポリシーの変更時には再度チェーンがフラッシュされるため、慎重に操作する必要があります。

**注意事項**：

- **リモートサーバーでの操作**:
  - リモートサーバー上でファイアウォール設定を変更する際は、特に注意が必要です。誤った設定によりリモート接続が遮断されるリスクがあるため、設定変更前に現在の接続状態を確認し、必要に応じてコンソールアクセスを確保しておくことを推奨します。
- **設定のバックアップ**:
  - ファイアウォール設定を変更する前に、現在の設定をバックアップしておくと、問題が発生した場合に元の状態に戻しやすくなります。例えば、以下のコマンドで現在のルールを保存できます：

    ```bash
    sudo ufw status verbose > ~/ufw-backup-$(date +%F).txt

    ```

## APPLICATION INTEGRATION

`ufw` は、`/etc/ufw/applications.d` に配置されたプロファイルを読み込むことで、アプリケーション統合をサポートしています。`ufw` に認識されているアプリケーションプロファイルの名前を一覧表示するには、以下のコマンドを使用します：

```bash
ufw app list
```

ユーザーはルールを追加する際にアプリケーション名を指定することができます（スペースを含むプロファイル名は引用符で囲んでください）。例えば、シンプルな構文を使用する場合、以下のように実行します：

```bash
ufw allow <name>
```

または、拡張構文を使用する場合は以下のようになります：

```bash
ufw allow from 192.168.0.0/16 to any app <name>
```

どちらの構文でもプロトコルを指定しないでください。拡張構文では、ポート部分の代わりに `app` を使用します。特定のアプリケーションに関するファイアウォールプロファイルの詳細は、以下のコマンドで確認できます：

```bash
ufw app info <name>

```

`<name>` は `ufw app list` コマンドで確認できるアプリケーションの名前のいずれかです。すべての既知のアプリケーションのプロファイルを表示するには、`all` を指定することもできます。

### Syntax for the application profiles (is a simple .INI format)

```ini
[<name>]
title=<title>
description=<description>
ports=<ports>
```

`ports` フィールドには、プロトコルがオプションの `|` で区切られたポート/プロトコルのリストを指定できます。
カンマ区切りのリストや範囲（`start:end` で指定）を使用して複数のポートを指定することも可能ですが、その場合はプロトコルが必須です。
例えば：

```ini
[SomeService]
title=Some title
description=Some description
ports=12/udp|34|56,78:90/tcp
```

上記の例では、`SomeService` はアプリールールで使用でき、UDP ポート 12、TCP および UDP ポート 34、TCP ポート 56 および 78-90（両端を含む）が指定されています。

アプリケーションプロファイルを作成または編集した後、更新されたプロファイル情報でファイアウォールを自動的に更新する：

```bash
ufw app update <name>
```

新しいルールをファイアウォールに自動的に追加してプロファイルを更新するには、以下のコマンドを実行できます：

```bash
ufw app update --add-new <name>
```

`update --add-new` コマンドの動作は、以下のコマンドで設定できる

```bash
ufw app default <policy>
```

デフォルトのアプリケーションポリシーは `skip` であり、これは `update --add-new` コマンドが何も行わないことを意味します。
ユーザーは `allow` または `deny` のポリシーを指定することもでき、`update --add-new` コマンドがファイアウォールを自動的に更新するようにできます。

<aside>
<img src="/icons/warning_yellow.svg" alt="/icons/warning_yellow.svg" width="40px" />

NOTE

アプリケーションプロファイルに対してデフォルトで `allow` ポリシーを使用することはセキュリティ上リスクとなる可能性があります。デフォルトで `allow` ポリシーを使用する前に、セキュリティへの影響を慎重に検討してください。

</aside>

### **補足情報：**

> **アプリケーションプロファイルの利点:**
>
- 一貫したルール管理が可能になり、特定のアプリケーションに対するアクセス制御が容易になります。
- プロファイルを使用することで、サービス名で簡単にルールを追加・管理できます。

> **プロファイルの作成と管理:**
>
- `/etc/ufw/applications.d/` ディレクトリに新しい `.ini` ファイルを作成することで、カスタムアプリケーションプロファイルを追加できます。
- 既存のプロファイルを編集する場合は、対応する `.ini` ファイルを編集し、`ufw app update <名前>` コマンドを実行してください。

> **セキュリティの注意点:**
>
- アプリケーションプロファイルを作成する際は、必要なポートとプロトコルのみを正確に指定し、不要なアクセスを防ぐようにしてください。
- デフォルトポリシーを変更する際は、既存のルールとの整合性を保つよう注意が必要です。

### **使用例：**

```bash
# **アプリケーションプロファイルの一覧表示**
ufw app list

# **特定のアプリケーションプロファイルの情報表示**
ufw app info OpenSSH

# **アプリケーションプロファイルを使用してルールを追加
ufw allow OpenSSH

# 新しいアプリケーションプロファイルを更新
ufw app update --add-new MyCustomApp**
```

---

### **注意事項**

- アプリケーションプロファイルを適切に管理し、セキュリティを維持するために、不要なポートやプロトコルを開放しないように注意してください。
- ファイアウォール設定を変更する際は、特にリモートサーバーの場合、接続が遮断されないよう十分に注意してください。必要に応じてコンソールアクセスや他のバックアップ手段を確保しておくことを推奨します。

## **LOGGING**

`ufw` は複数のロギングレベルをサポートしています。ロギング設定を適切に管理することで、ファイアウォールの動作状況を効果的に監視・管理することができます。

ロギングレベルが指定されていない場合、`ufw` はデフォルトで `low` レベルに設定されます。ユーザーは以下のコマンドでロギングレベルを指定することができます：

```bash
ufw logging LEVEL
```

### `LEVEL`

`LEVEL` には `off`, `low`, `medium`, `high`, `full` のいずれかを指定できます。ロギングレベルは以下のように定義されています：

| LEVEL | 説明 |
| --- | --- |
| **`off`** | `ufw` が管理するロギングを無効 |
| **`low | on`**   | 定義されたポリシーに一致しないすべてのブロックされたパケット（レート制限付き）およびロギングされたルールに一致するパケットをログに記録
(基本的なブロックされたパケットとログルールに一致するパケットのみを記録) |
| **`medium`** | ログレベル `low` に加え、定義されたポリシーに一致しないすべての許可されたパケット、すべての `INVALID` パケット、およびすべての新しい接続をログに記録します。すべてのロギングはレート制限付きで行われます
(より詳細なログを取得し、許可されたパケットや新しい接続も含める) |
| **`high`** | ログレベル `medium`（レート制限なし）に加え、レート制限付きのすべてのパケットをログに記録します |
| **`full`** | ログレベル `high`（レート制限なし）に設定します
最も詳細なログを取得し、レート制限なしで全てのパケットを記録 |

`medium` 以上のロギングレベルは大量のロギング出力を生成し、ディスクが急速に満杯になる可能性があります。`medium` レベルでも、特に忙しいシステムでは大量のロギング出力が生成されることがあります。

`on` を指定すると、現在ロギングが有効でない場合にロギングレベル `low` を有効にします。

---

### **補足情報：**

- **レート制限**：
  - レート制限は、ログの量を制御し、システムのパフォーマンスに与える影響を軽減するために使用されます。`medium` レベルではレート制限が適用されますが、`high` および `full` レベルではレート制限の有無が異なります。
- **ディスク容量の管理**：
  - 高いロギングレベルを設定すると、大量のログが生成されるため、ディスク容量が急速に消費される可能性があります。特に `medium` レベル以上を設定する場合は、ログファイルの管理やローテーションを適切に行うことをおすすめします。
- **ログファシリティ**：
  - ログに記録されるパケットは `LOG_KERN` の syslog ファシリティを使用します。`rsyslog` をサポートするシステムでは、`/var/log/ufw.log` にもログが記録される場合があります。

### **使用例：**

1. **ロギングレベルの設定**：

    ```bash
    ufw logging medium
    ```

2. **ロギングの有効化**：

    ```bash
    ufw logging on
    ```

3. **ロギングレベルの確認**：
現在のロギング設定を確認するには、ステータスを表示します。

    ```bash
    ufw status verbose
    ```

4. **ロギングの無効化**：

    ```bash
    ufw logging off
    ```

---

### **注意事項**

- ロギングレベルを `medium` 以上に設定すると、ログファイルが急速に増加する可能性があるため、ディスク容量に注意してください。
- リモートサーバーで `ufw` を使用している場合、適切なロギングレベルを設定して問題のトラブルシューティングやセキュリティ監視を行うことが重要です。
- ログファイルの管理やローテーションを設定して、ディスクスペースの不足を防ぐようにしてください。

---

## REPORTS

以下のレポートがサポートされています。各レポートはライブシステムに基づいており、リスニングレポートを除いて、すべて生の `iptables` フォーマットで提供されます：

- `raw`
- `builtins`
- `before-rules`
- `user-rules`
- `after-rules`
- `logging-rules`
- `listening`
- `added`

### レポートの詳細

- **raw**
  - 完全なファイアウォール設定を表示します。他のレポートは `raw` レポートのサブセットを表示します。
- **builtins**
  - `raw` レポート内の組み込みチェーンに関連するルールを表示します。
- **before-rules**
  - `raw` レポート内の初期ルールセットを表示します。
- **user-rules**
  - ユーザーが追加したルールのみを表示します。
- **after-rules**
  - `raw` レポート内の後続ルールセットを表示します。
- **logging-rules**
  - ロギングに関連するルールのみを表示します。
- **listening**
  - ライブシステム上でリスニング状態の TCP ポートおよびオープン状態の UDP ポートを表示します。これには、インターフェースのアドレスと、そのポートでリスニングしている実行可能ファイルの情報が含まれます。実行可能ファイルがそのポート上のすべてのインターフェースにバインドされている場合、インターフェースのアドレスの代わりに `` が使用されます。この情報に続いて、そのポート上の接続に影響を与える可能性のあるルールのリストが表示されます。ルールはカーネルによって評価される順序でリストされ、最初に一致したルールが適用されます。デフォルトポリシーは表示されず、`tcp6` および `udp6` は IPv6 が有効になっている場合のみ表示されます。
- **added**
  - コマンドラインで追加されたルールのリストを表示します。このレポートは、実行中のファイアウォールのステータスを表示しません（代わりに `ufw status` を使用してください）。`ufw` によってルールが正規化されるため、ルールは元々追加されたルールとは異なって見える場合があります。また、`ufw` はコマンドの順序を記録しないため、IPv6 専用のルールは他のルールの後にリストされるなど、同等の順序が使用されます。

### 使用例

1. **利用可能なレポートの一覧表示**：

    ```bash
    # **ファイアウォールの全体的な状態を確認**
    ufw show raw

    ufw show builtins
    ufw show before-rules

    # **ユーザーが追加したルールのみを確認**
    ufw show user-rules
    ufw show after-rules
    ufw show logging-rules

    # **特定のインターフェースでのルールを確認(リスニングレポートの表示)**
    ufw show listening

    # **追加されたルールのレポートを表示**
    ufw show added
    ```

### 注意事項

- **レポートの理解**：
  - 各レポートはファイアウォールの異なる側面を反映しており、特定の目的に応じて使用します。例えば、`listening` レポートは現在リスニングしているサービスを確認するのに有用です。
- **セキュリティの確認**：
  - レポートを定期的に確認し、不要なサービスや不正なルールが存在しないことを確認することで、システムのセキュリティを維持します。
- **レポートの制限**：
  - `raw` レポートは完全なファイアウォール設定を表示するため、機密性の高い情報が含まれる場合があります。必要に応じて適切な権限でアクセスしてください。

---

**補足情報：**

- **レポートのカスタマイズ**：
  - `ufw` のレポート機能を活用して、ファイアウォールの状態やルールの影響を詳細に把握できます。特定のレポートを組み合わせて使用することで、包括的なセキュリティ監視が可能になります。
- **自動化とスクリプト**：
  - レポートの生成を自動化するスクリプトを作成することで、定期的なセキュリティチェックを効率化できます。例えば、システム監視ツールと連携して `ufw` レポートを解析し、異常を検出することができます。

---

## NOTES

インストール時に、`ufw` はデフォルトで以下の設定で無効化されます：

- **デフォルトのポリシー**：
  - **入力ポリシー**：拒否 (`deny`)
  - **転送ポリシー**：拒否 (`deny`)
  - **出力ポリシー**：許可 (`allow`)
- **状態追跡**：
  - 入力および転送される接続に対して、新しい接続の状態追跡が有効になっています。
- **デフォルトのルールセット**：
  - **RH0ヘッダーを持つパケットをドロップ**：
    - RH0（Routing Header Type 0）ヘッダーを持つパケットをドロップします。
  - **INVALIDパケットをドロップ**：
    - 不正な状態のパケットをドロップします。
  - **特定のICMPパケットを受け入れる（INPUTおよびFORWARD）**：
    - IPv4では、宛先到達不能、ソースクエンチ、タイムエクスパイア、パラメータ問題、およびエコーリクエスト。
    - IPv6では、宛先到達不能、パケットサイズ超過、タイムエクスパイア、パラメータ問題、およびエコーリクエスト。
  - **ステートレス自動構成用のICMPv6パケットを受け入れる（INPUT）**：
    - IPv6のステートレス自動構成に必要なICMPv6パケットを受け入れます。
  - **IPv6リンクローカル（ffe8::/10）アドレスからのping返信を受け入れる（INPUT）**：
    - IPv6のリンクローカルアドレスからのping返信を受け入れます。
  - **DHCPクライアントトラフィックを受け入れる（INPUT）**：
    - DHCPクライアントからのトラフィックを受け入れます。
  - **非ローカルトラフィックをドロップ（INPUT）**：
    - ホスト自身を対象としないトラフィックをドロップします。
  - **サービス発見用のmDNS（zeroconf/bonjour/avahi 224.0.0.251 for IPv4 and ff02::fb for IPv6）を受け入れる（INPUT）**：
    - mDNSを使用したサービス発見用のトラフィックを受け入れます。
  - **サービス発見用のUPnP（239.255.255.250 for IPv4 and ff02::f for IPv6）を受け入れる（INPUT）**：
    - UPnPを使用したサービス発見用のトラフィックを受け入れます。

### ルールの順序の重要性

ルールの順序は重要であり、最初に一致したルールが適用されます。したがって、ルールを追加する際には、より具体的なルールを先に追加し、より一般的なルールを後に追加するようにしてください。

### `ufw` の機能制限

`ufw` はコマンドインターフェースを通じて完全なファイアウォール機能を提供することを目的としておらず、代わりにシンプルなルールの追加や削除を簡単に行えるように設計されています。

### ステータスコマンドの制限

`status` コマンドはファイアウォールの状態および `ufw` コマンドで管理されているルールに関する基本的な情報を表示します。ただし、`/etc/ufw` のルールファイルからのルールは表示されません。ファイアウォールの完全な状態を確認するには、以下のコマンドを使用します：

```bash
ufw show raw

```

これは、以下のコマンドを使用して `filter`, `nat`, `mangle`, `raw` テーブルを表示します：

```bash
iptables -n -L -v -x -t <table>
ip6tables -n -L -v -x -t <table>

```

詳細については、`iptables` および `ip6tables` のドキュメントを参照してください。

### デフォルトポリシーと外部ルールの干渉

デフォルトポリシーが `REJECT` に設定されている場合、`ufw` フレームワーク外で追加されたルールと干渉する可能性があります。詳細については、`README` を参照してください。

### IPv6 の扱い

デフォルトでIPv6は有効になっています。この動作を変更し、ループバックインターフェースでのみIPv6トラフィックを受け入れるようにするには、`/etc/default/ufw` の `IPV6` を `no` に設定し、`ufw` をリロードします。IPv6が有効になっている場合、IPv4ルールと同様の方法でルールを指定でき、`ufw status` で表示されます。IPv4およびIPv6の両方のアドレスにマッチするルールは、両方のIPバージョンに適用されます。例えば、IPv6が有効になっている場合、以下のルールはIPv4およびIPv6トラフィックの両方に対してポート22へのアクセスを許可します：

```bash
ufw allow 22

```

### IPv6 トンネルと6to4のサポート

IPv4トンネルおよび6to4は、`ipv6` プロトコル（`41`）を使用することでサポートされています。このプロトコルはフル構文でのみ使用できます。例えば：

```bash
ufw allow to 10.0.0.1 proto ipv6
ufw allow to 10.0.0.1 from 10.4.0.0/16 proto ipv6

```

### IPSec のサポート

IPSecは、`esp`（`50`）および `ah`（`51`）プロトコルを使用することでサポートされています。これらのプロトコルはフル構文でのみ使用できます。例えば：

```bash
ufw allow to 10.0.0.1 proto esp
ufw allow to 10.0.0.1 from 10.4.0.0/16 proto esp
ufw allow to 10.0.0.1 proto ah
ufw allow to 10.0.0.1 from 10.4.0.0/16 proto ah

```

### 追加機能

コマンドラインインターフェースに加えて、`ufw` は管理者がデフォルトの動作を変更したり、`netfilter` をフル活用したりするためのフレームワークも提供しています。詳細については、`ufw-framework` マニュアルページを参照してください。

---

**補足情報：**

- **デフォルト設定の理解**：
  - インストール時のデフォルト設定を理解することで、`ufw` の動作をより効果的に管理できます。特にデフォルトポリシーや既定のルールセットがシステムのセキュリティにどのように影響するかを把握することが重要です。
- **ルールの順序**：
  - ファイアウォールルールの評価順序を理解することで、意図したトラフィックが適切に許可または拒否されるように設定できます。具体的なルールを追加する際には、特定の条件を先に配置し、一般的な条件を後に配置するように心掛けてください。
- **IPv6 の管理**：
  - IPv6を有効にすることで、より多くのトラフィックタイプやネットワーク構成に対応できます。ただし、セキュリティ設定を適切に管理しないと、新たな脆弱性が生じる可能性があります。IPv6関連のルール設定を行う際は、特に注意してください。
- **ファイアウォールの限界**：
  - `ufw` はシンプルなルール管理に適していますが、より複雑なファイアウォール設定や高度なネットワーク制御が必要な場合は、直接 `iptables` や `ip6tables` を使用することを検討してください。

**注意事項：**

- **リモートサーバーでの設定変更**：
  - リモートサーバー上でファイアウォール設定を変更する際は、特に注意が必要です。誤った設定によりリモート接続が遮断されるリスクがあるため、設定変更前に現在の接続状態を確認し、必要に応じてコンソールアクセスを確保しておくことを推奨します。
- **設定のバックアップ**：
  - ファイアウォール設定を変更する前に、現在の設定をバックアップしておくことで、問題が発生した場合に元の状態に戻しやすくなります。例えば、以下のコマンドで現在のルールを保存できます：

    ```bash
    sudo ufw status verbose > ~/ufw-backup-$(date +%F).txt
    ```

- **公式ドキュメントの参照**：
  - `ufw` の詳細な使用方法や追加オプションについては、公式ドキュメントや `man ufw` を参照してください。これにより、最新の機能やベストプラクティスを把握できます。

---

以上が、`ufw` コマンドマニュアルの **NOTES** セクションの日本語翻訳です。`ufw` の設定を変更する際は、システムのセキュリティと接続の可用性を確保するために、十分な注意を払ってください。

## シナリオ

[無題](https://www.notion.so/128c6d8c64d0814ab03dd425e23c9eff?pvs=21)

### その他

> **AUTHORS**
>

ufw is Copyright 2008-2021, Canonical Ltd.

> **SEE ALSO**
>

ufw-framework(8), iptables(8), ip6tables(8), iptables-restore(8), ip6tables-restore(8), sysctl(8), sysctl.conf(5)

> **REPORTING BUGS**
>

> **AVAILABILITY**
>
