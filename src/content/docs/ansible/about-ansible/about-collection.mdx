---
title: コレクション
description: コレクションについての説明。使用方法
tags:
  - "Ansible"
sidebar:
  # このリンクのカスタムラベルを設定します
  label: コレクション
  # このリンクの順番をカスタマイズします（数字が小さいほど上に表示されます）
  order: 30
  # このリンクにバッジを追加します
  # badge:
  #     text: ""
  #     variant: tip
---

import { LinkCard, Tabs, TabItem, Steps, FileTree } from "@astrojs/starlight/components";
import LinkPreview from "@components/LinkPreview.astro";
import MermaidChart from "@components/MermaidChart.astro";
import Table from "@components/Table.astro";

## コレクションとは

コレクションとは、モジュール、プラグイン、プレイブックなどをまとめた管理単位のことです。
コレクションは Ansible 2.8 から試験的導入が開始され、2.10 でコアから切り離され、内蔵されていたモジュール群の多くがコレクションに移行された。
ここからコレクションは独立した開発リリースサイクルを行うことができるようになりました。

コレクション名は、`ansible.utils` や、`community.general`、`cisco.ios` などのように名前空間が設けられている。さらに `.` で区切られた先にモジュールが存在している。
例えば、`ios_command` モジュールは `cisco.ios.ios_command` という FQCN (Fully Qualified Collection Name) で表記して利用する。

ansible-core が標準で内蔵している `ansible.builtin` コレクションとして扱われる。

### Ansible Galaxy

コミュニティとしてのコレクションは Ansible Galaxy で管理、配布されています。

<LinkPreview url="https://galaxy.ansible.com/ui/" />
<LinkPreview url="https://ansible.readthedocs.io/projects/galaxy-ng/en/latest/community/userguide/" />

#### ansible.utils のコレクションを確認

Ansible Galaxy のリポジトリページを確認してみる。

<LinkPreview url="https://galaxy.ansible.com/ui/search/?keywords=utils" />

- [ansible.utils コレクション](https://galaxy.ansible.com/ui/repo/published/ansible/utils/)
- [リポジトリページ](https://github.com/ansible-collections/ansible.utils)

#### コレクションのインストール

```bash frame=none
ansible-galaxy collection install コレクション名

# ex.
ansible-galaxy collection install cisco.ios
```

コレクション名と同時にインストールしたいバージョンを指定できる。
例えば、`コレクション名:==2.0.0` のように指定できる。`'コレクション名:>=2.0.0'` で 2.0.0 以上の最新バージョンをインストールしてくれます。
`>` というシェル上で特別な意味を持つ文字を含む場合はクォーテーションで囲んで指定できる。

[インストール先について](#collections_scan_sys_path)

##### `requirements.yaml` 複数コレクションの一括インストール

`requirements.yaml` を利用して、インストールしたいコレクションを定義します。

```yaml
---
collections:
  # コレクション名のみシーケンスで指定
  - ansible.posix
  # バージョンを指定する場合
  - name: ansible.utils
    version: 2.2.0
```

`requirements.yaml` を利用してインストールするには、`-r` オプションで指定します。

```bash frame=none
ansible-galaxy collection install -r requirements.yaml

# インストール先を COLLECTIONS_PATH とは違うものにする場合は、
ansible-galaxy collection install -r requirements.yaml -p インストール先パス
```

#### インストール済みコレクション一覧

```bash frame=none
# インストール済みコレクション一覧を表示
ansible-galaxy collection list

# /opt/homebrew/Cellar/ansible/11.1.0/libexec/lib/python3.13/site-packages/ansible_collections
Collection                               Version
---------------------------------------- -------
amazon.aws                               9.0.0
ansible.netcommon                        7.1.0
ansible.posix                            1.6.2
ansible.utils                            5.1.2
ansible.windows                          2.5.0
arista.eos                               10.0.1
awx.awx                                  24.6.1
azure.azcollection                       3.1.0
check_point.mgmt                         6.2.1
chocolatey.chocolatey                    1.5.3
cisco.aci                                2.10.1
cisco.asa                                6.0.0
cisco.dnac                               6.25.0
cisco.intersight                         2.0.20
cisco.ios                                9.0.3
cisco.iosxr                              10.2.2
cisco.ise                                2.9.6
cisco.meraki                             2.18.3
cisco.mso                                2.9.0
cisco.nxos                               9.2.1
cisco.ucs                                1.14.0
cloud.common                             4.0.0
cloudscale_ch.cloud                      2.4.0
community.aws                            9.0.0
community.ciscosmb                       1.0.9
community.crypto                         2.22.3
community.digitalocean                   1.27.0
community.dns                            3.1.0
community.docker                         4.1.0
community.general                        10.1.0
community.grafana                        2.1.0
community.hashi_vault                    6.2.0
community.hrobot                         2.0.2
community.library_inventory_filtering_v1 1.0.2
community.libvirt                        1.3.0
community.mongodb                        1.7.8
community.mysql                          3.11.0
community.network                        5.1.0
community.okd                            4.0.0
community.postgresql                     3.9.0
community.proxysql                       1.6.0
community.rabbitmq                       1.3.0
community.routeros                       3.1.0
community.sap_libs                       1.4.2
community.sops                           2.0.0
community.vmware                         5.2.0
community.windows                        2.3.0
community.zabbix                         3.2.0
containers.podman                        1.16.2
cyberark.conjur                          1.3.1
cyberark.pas                             1.0.30
dellemc.enterprise_sonic                 2.5.1
dellemc.openmanage                       9.9.0
dellemc.powerflex                        2.5.0
dellemc.unity                            2.0.0
f5networks.f5_modules                    1.32.1
fortinet.fortimanager                    2.8.2
fortinet.fortios                         2.3.8
google.cloud                             1.4.1
grafana.grafana                          5.6.0
hetzner.hcloud                           4.2.2
ibm.qradar                               4.0.0
ibm.spectrum_virtualize                  2.0.0
ibm.storage_virtualize                   2.5.0
ieisystem.inmanage                       3.0.0
infinidat.infinibox                      1.4.5
infoblox.nios_modules                    1.7.1
inspur.ispim                             2.2.3
junipernetworks.junos                    9.1.0
kaytus.ksmanage                          2.0.0
kubernetes.core                          5.0.0
kubevirt.core                            2.1.0
lowlydba.sqlserver                       2.3.4
microsoft.ad                             1.7.1
netapp.cloudmanager                      21.24.0
netapp.ontap                             22.13.0
netapp.storagegrid                       21.13.0
netapp_eseries.santricity                1.4.1
netbox.netbox                            3.20.0
ngine_io.cloudstack                      2.5.0
openstack.cloud                          2.3.0
ovirt.ovirt                              3.2.0
purestorage.flasharray                   1.32.0
purestorage.flashblade                   1.19.1
sensu.sensu_go                           1.14.0
splunk.es                                4.0.0
telekom_mms.icinga_director              2.2.1
theforeman.foreman                       4.2.0
vmware.vmware                            1.7.1
vmware.vmware_rest                       4.3.0
vultr.cloud                              1.13.0
vyos.vyos                                5.0.0
wti.remote                               1.0.10
```

インストール済みのコレクションとインストールされているパスも合わせて表示してくれる。
COLLECTIONS_PATHS と COLLECTIONS_SCAN_SYS_PATH の指定に基づいたコレクションの検索結果となります。

`-p` でオプションとしてそれ以外の検索パスを指定することもできます。

インストールされているパス配下にコレクションのディレクトリがあります。

<FileTree>

- ansible_collection
  - ansible/
    - netcommon/ # この階層のディレクトリにプラグインのコードがある
    - posix/
    - utils/
    - windows/

</FileTree>

#### コレクションのアップグレード

インストール済みのコレクションをアップグレードするには、

```bash frame=none
# ex. ansible.utils コレクションの更新
ansible-galaxy collection install ansible.utils -U
```

#### コレクションの削除

コレクションの削除には ansible-galaxy collection の API には存在しないようです。
削除には、インストール先のディレクトリを削除する。
例えば、ansibles.utils コレクションを削除する場合は

```bash
rm -rf インストールされたパスのansible_collections/ansible/utils
```

### コレクションの検索対象パス

プレイブック内で、`cisco.ios.ios_command` のようにモジュールを FQCN で指定すると、
ansible の設定にもとづいて、コレクションを検索する。検索するパスは以下で確認できる

```bash frame=none
ansible-config dump | grep COLLECTIONS
...
COLLECTIONS_PATHS(default) = ['/Users/t_inoue/.ansible/collections', '/usr/share/ansible/collections']
COLLECTIONS_SCAN_SYS_PATH(default) = True
...
```

#### COLLECTIONS_PATHS

コレクションの検索対象パスを指定する項目。
デフォルトは

1. `~/.ansible/collections`
1. `/usr/share/ansible/collections`

の順です。

#### COLLECTIONS_SCAN_SYS_PATH

Python のモジュール検索対象パスである、sys.path (例: /home/ansible/myvenv/lib/python3.9/site-package)配下を、
コレクションの検索対象にするかどうかを true/false で指定する。(デフォルトは True)

Ansible Community Package の同梱コレクションは、このパス配下の `ansible_collections` ディレクトリに格納されます。

:::note[検索対象パスの変更設定]

ansible.cfg で検索対象パスを変更するには以下のように設定を行う。
`/opt/collections` に設定をしたい場合は

```ini
[default]
collections_paths=/opt/collections
```

:::

:::caution[FQCN へのリダイレクト参照について]

ansible-core は、単にモジュール名のみを指定した場合はどの FQCN にリダイレクトするかの対応表を持っています。
この対応表より、プレイブック内で ios_command を指定した場合、cisco.ios.ios_command として処理してくれる。

インストールされている ansible-core のバージョンでこの対応表が管理されているため、リダイレクトの機能がすべて効果してくれるわけではありません。
ansible-lint を設定していると、実行時に警告が発生し、対応できないで実行失敗することもあります。
基本的には、モジュールの利用時には、FQCN で記述を行ってください。

:::
