---
title: 制御ディレクティブ
description: 制御ディレクティブ、loop、rescue などの制御について
tags:
  - "Ansible"
sidebar:
  # このリンクのカスタムラベルを設定します
  label: 制御ディレクティブ
  # このリンクの順番をカスタマイズします（数字が小さいほど上に表示されます）
  order: 30
  # このリンクにバッジを追加します
  # badge:
  #     text: ""
  #     variant: tip
---

import { LinkCard, Tabs, TabItem, Steps, FileTree } from "@astrojs/starlight/components";
import LinkPreview from "@components/LinkPreview.astro";
import MermaidChart from "@components/MermaidChart.astro";
import Table from "@components/Table.astro";

## タスクの繰り返し制御のディレクティブ

タスク内で実行する処理に制御をかけるディレクティブ

### `loop` ディレクティブ

同一タスクを複数回実行するためのディレクティブ。loop ディレクティブには item という変数(シーケンス型)が用意されており、
タスクに item を渡すことで複数処理の実行が行える

<Steps>

1. 以下のようなユーザーアカウントを 3 つ作成するプレイがある

   ```yaml
   ---
   - name: Register a user account.
     hosts: ec2
     become: true

     tasks:
       - name: Create user account 1
         ansible.builtin.user:
           name: taro
       - name: Create user account 2
         ansible.builtin.user:
           name: jiro
       - name: Create user account 3
         ansible.builtin.user:
           name: hanako
   ```

1. loop ディレクティグによって書き換えると

   ```yaml
   ---
   - name: Register a user account.
     hosts: ec2
     become: true

     tasks:
       - name: Create user account
         ansible.builtin.user:
           name: "{{ item }}"
         loop:
           - taro
           - jiro
           - hanako
   ```

</Steps>

#### シーケンスにマッピングを利用した loop

デバッグで、シーケンスに格納したマッピングを利用した場合の処理を確認するプレイブックを用意しました。

```yaml
---
- name: Check the value to be set to the loop variable.
  hosts: ec2
  gather_facts: false

  tasks:
    - name: Check the value of the loop variable.
      ansible.builtin.debug:
        var: item
      loop:
        - user_name: taro
          user_password: password@taro
        - user_name: jiro
          user_password: password@jiro
        - user_name: hanako
          user_password: password@hanako
```

こちらをデバッグ目的のため実行すると

```bash frame=none
ansible-playbook -i ansible/inventory/hosts.yaml ansible/playbook/debug_loop_directive.yaml

PLAY [Check the value to be set to the loop variable.] ********************************************************************

TASK [Check the value of the loop variable.] ******************************************************************************
ok: [web01] => (item={'user_name': 'taro', 'user_password': 'password@taro'}) => {
    "ansible_loop_var": "item",
    "item": {
        "user_name": "taro",
        "user_password": "password@taro"
    }
}
ok: [web01] => (item={'user_name': 'jiro', 'user_password': 'password@jiro'}) => {
    "ansible_loop_var": "item",
    "item": {
        "user_name": "jiro",
        "user_password": "password@jiro"
    }
}
ok: [web01] => (item={'user_name': 'hanako', 'user_password': 'password@hanako'}) => {
    "ansible_loop_var": "item",
    "item": {
        "user_name": "hanako",
        "user_password": "password@hanako"
    }
}

PLAY RECAP ****************************************************************************************************************
web01                      : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

デバッグ内容が確認できたので、マッピング変数の配列を利用してユーザー作成を行なった処理が以下となる。

```yaml
---
- name: Register a user account.
  hosts: ec2
  become: true

  tasks:
    - name: Create user account
      ansible.builtin.user:
        name: "{{ item['user_name'] }}"
        password: "{{ item['user_password'] | password_hash('sha512') }}"
      loop:
        - user_name: taro
          user_password: password@taro
        - user_name: jiro
          user_password: password@jiro
        - user_name: hanako
          user_password: password@hanako
```

#### vars セクションで定義した変数を loop で利用する

パスワードなど機密性の高い内容をバージョン管理に含めないように、var_files で定義したい。
まずは、vars セクションで item の内容をあらかじめ宣言して利用する方法を踏まえ、その後、var_files からの変数を利用した loop 処理実行の確認まで行ってみようと思います。

<Steps>

1. まず、前章の `loop` で定義したシーケンスの値を `vars` で宣言して利用したプレイブックの書き方

   ```yaml
   ---
   - name: Register a user account.
     hosts: ec2
     become: true

     vars:
       accounts:
         - user_name: taro
           user_password: password@taro
         - user_name: jiro
           user_password: password@jiro
         - user_name: hanako
           user_password: password@hanako

     tasks:
       - name: Create user account
         ansible.builtin.user:
           name: "{{ item['user_name'] }}"
           password: "{{ item['user_password'] | password_hash('sha512') }}"
         loop: "{{ accounts }}"
   ```

1. vars での宣言を var_files で書き換えるようにする

   ```yaml title="ansible/vars/accounts.yaml"
   ---
   accounts:
     - user_name: taro
       user_password: password@taro
     - user_name: jiro
       user_password: password@jiro
     - user_name: hanako
       user_password: password@hanako
   ```

   ```yaml title="ansible/create_user.yaml"
    ---
    - name: Register a user account.
      hosts: ec2
      become: true

      vars_files:
        - ./vars/accounts.yaml

      tasks:
        - name: Create user account
          ansible.builtin.user:
            name: "{{ item['user_name'] }}"
            password: "{{ item['user_password'] | password_hash('sha512') }}"
          loop: "{{ accounts }}"
   ```

</Steps>

#### スコープを絞る(タスク変数として定義)

プレイブック内で、一つのタスク内でのみ利用する変数であるのであれば、スコープを絞って変数を定義するのも一つの手です。

```yaml
---
- name: Register a user account.
  hosts: ec2
  become: true

  tasks:
    - name: Create user account
      ansible.builtin.user:
        name: "{{ item['user_name'] }}"
        password: "{{ item['user_password'] | password_hash('sha512') }}"
      loop: "{{ accounts }}"
      vars:
        accounts:
          - user_name: taro
            user_password: password@taro
          - user_name: jiro
            user_password: password@jiro
          - user_name: hanako
            user_password: password@hanako
```

今回のバージョン管理ファイルに含めないことを考えれば、`var_files` を利用することが適切

### `loop_control`

#### `loop_var` ループ変数を指定する

loop ディレクティブを利用するときは、item 変数にシーケンス型の値が格納される。
loop_var ディレクティブを利用すると、item 以外の変数でループ変数を定義できる。これによりコードの可読性が上げられます。

```yaml title="ansible/playbook/install_apache.yaml"
---
- name: Install the packages related to Apache.
  hosts: ec2
  gather_facts: false
  become: true

  tasks:
    - name: Install the package.
      ansible.builtin.apt:
        name: "{{ package_name }}"
        state: present
      loop: "{{ packages }}"
      loop_control:
        loop_var: package_name
      vars:
        packages:
          - apache2
          - apache2-utils
          - apache2-dev
          - apache2-doc
```

#### `index_var` インデックス番号を利用した処理

ループ処理の中で、インデックス番号を利用した処理を使うには index_var パラメータでインデックス値の変数を定義します。
インデックスの最初は 0 番です。

```yaml title="ansible/playbook/install_apache.yaml"
---
- name: Install the packages related to Apache.
  hosts: ec2
  gather_facts: false
  become: true

  tasks:
    - name: Install the package.
      ansible.builtin.debug:
        msg: "{{ loop_count }} -> {{ item }}"
      loop: "{{ packages }}"
      loop_control:
        index_var: loop_count
      vars:
        packages:
          - apache2
          - apache2-utils
          - apache2-dev
          - apache2-doc
```

ループのログ

```bash frame=none
ansible-playbook -i ansible/inventory/hosts.yaml ansible/playbook/install_apache.yaml

PLAY [Install the packages related to Apache.] ****************************************************************************

TASK [Install the package.] ***********************************************************************************************
ok: [web01] => (item=apache2) => {
    "msg": "0 -> apache2"
}
ok: [web01] => (item=apache2-utils) => {
    "msg": "1 -> apache2-utils"
}
ok: [web01] => (item=apache2-dev) => {
    "msg": "2 -> apache2-dev"
}
ok: [web01] => (item=apache2-doc) => {
    "msg": "3 -> apache2-doc"
}

PLAY RECAP ****************************************************************************************************************
web01                      : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

#### `pause` ループの一定時間停止

##### `pause` の基本的な使い方

`pause` ディレクティブを使用するとタスクの実行後、指定秒数でだけ実行を停止 (ポーズ) します。
タスクを実行すると 10 秒停止後、タスクの実行を再開します。
10 秒ごとに `date` コマンドを 3 回実行するプレイブックです。

<Steps>

1. pause を利用したプレイブック

   ```yaml title="pause.yaml"
   ---
   - name: Pause tasks
     hosts: localhost
     gather_facts: false
     connection: ansible.builtin.local

     tasks:
       - name: Pause 10 seconds
         ansible.builtin.pause:
           seconds: 10
       - name: Pause 1 minutes
         ansible.builtin.pause:
           minutes: 1
   ```

1. プレイブックの実行

   ```bash frame=none
   ansible-playbook -i ./ansible/inventory/local.ini ./ansible/playbook/pause.yaml
   ```

   実行結果

   ```
   PLAY [Pause tasks] ********************************************************************************************************

   TASK [Pause 10 seconds] ***************************************************************************************************
   Pausing for 10 seconds
   (ctrl+C then 'C' = continue early, ctrl+C then 'A' = abort)
   ok: [127.0.0.1]

   TASK [Pause 1 minutes] ****************************************************************************************************
   Pausing for 60 seconds
   (ctrl+C then 'C' = continue early, ctrl+C then 'A' = abort)
   ok: [127.0.0.1]

   PLAY RECAP ****************************************************************************************************************
   127.0.0.1                  : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
   ```

   10 秒まって、次のタスク、60 秒待って次のタスクを実行している。

</Steps>

<Table
  columns={["パラメータ名", "説明"]}
  data={[
    ["minutes", "停止する分を指定する"],
    ["seconds", "停止する秒数を指定する"],
  ]}
/>

停止中に `ctrl + C` 後に `C` を入力すると停止時間を待たずに次のタスクに移る。
`ctrl + C` 後に `ctrl + A` を入力すると処理が中断される。

##### ループ処理内での `pause` 実行

```yaml
---
- name: Stops the execution of the tas for the specified time.
  hosts: ec2
  gather_facts: false

  tasks:
    - name: Get the date and time
      ansible.builtin.command:
        cmd: date
      register: result
      loop:
        - 1
        - 2
        - 3
      loop_control:
        pause: 10
      changed_when: false
    - name: Display the result
      ansible.builtin.debug:
        var: result
```

```bash frame=none
ansible-playbook -i ansible/inventory/hosts.yaml ansible/playbook/pause_task.yaml
```

```text title="実行ログ"
PLAY [Stops the execution of the tas for the specified time.] **************************************************

TASK [Get the date and time] ***********************************************************************************
ok: [web01] => (item=1)
ok: [web01] => (item=2)
ok: [web01] => (item=3)

TASK [Display the result] **************************************************************************************
ok: [web01] => {
    "result": {
        "changed": false,
        "msg": "All items completed",
        "results": [
            {
                "ansible_loop_var": "item",
                "changed": false,
                "cmd": [
                    "date"
                ],
                "delta": "0:00:00.003858",
                "end": "2025-01-05 04:07:08.559973",
                "failed": false,
                "invocation": {
                    "module_args": {
                        "_raw_params": "date",
                        "_uses_shell": false,
                        "argv": null,
                        "chdir": null,
                        "creates": null,
                        "executable": null,
                        "expand_argument_vars": true,
                        "removes": null,
                        "stdin": null,
                        "stdin_add_newline": true,
                        "strip_empty_ends": true
                    }
                },
                "item": 1,
                "msg": "",
                "rc": 0,
                "start": "2025-01-05 04:07:08.556115",
                "stderr": "",
                "stderr_lines": [],
                "stdout": "Sun Jan  5 04:07:08 UTC 2025",
                "stdout_lines": [
                    "Sun Jan  5 04:07:08 UTC 2025"
                ]
            },
            {
                "ansible_loop_var": "item",
                "changed": false,
                "cmd": [
                    "date"
                ],
                "delta": "0:00:00.007001",
                "end": "2025-01-05 04:07:22.197788",
                "failed": false,
                "invocation": {
                    "module_args": {
                        "_raw_params": "date",
                        "_uses_shell": false,
                        "argv": null,
                        "chdir": null,
                        "creates": null,
                        "executable": null,
                        "expand_argument_vars": true,
                        "removes": null,
                        "stdin": null,
                        "stdin_add_newline": true,
                        "strip_empty_ends": true
                    }
                },
                "item": 2,
                "msg": "",
                "rc": 0,
                "start": "2025-01-05 04:07:22.190787",
                "stderr": "",
                "stderr_lines": [],
                "stdout": "Sun Jan  5 04:07:22 UTC 2025",
                "stdout_lines": [
                    "Sun Jan  5 04:07:22 UTC 2025"
                ]
            },
            {
                "ansible_loop_var": "item",
                "changed": false,
                "cmd": [
                    "date"
                ],
                "delta": "0:00:00.003587",
                "end": "2025-01-05 04:07:35.748914",
                "failed": false,
                "invocation": {
                    "module_args": {
                        "_raw_params": "date",
                        "_uses_shell": false,
                        "argv": null,
                        "chdir": null,
                        "creates": null,
                        "executable": null,
                        "expand_argument_vars": true,
                        "removes": null,
                        "stdin": null,
                        "stdin_add_newline": true,
                        "strip_empty_ends": true
                    }
                },
                "item": 3,
                "msg": "",
                "rc": 0,
                "start": "2025-01-05 04:07:35.745327",
                "stderr": "",
                "stderr_lines": [],
                "stdout": "Sun Jan  5 04:07:35 UTC 2025",
                "stdout_lines": [
                    "Sun Jan  5 04:07:35 UTC 2025"
                ]
            }
        ],
        "skipped": false
    }
}

PLAY RECAP *****************************************************************************************************
web01                      : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

#### `until`、`retries`、`delay`で繰り返しの制御

##### `until` による条件付き繰り返し処理

`until` は条件が満たされるまでタスクを繰り返し実行するディレクティブです。`retries` で最大試行回数を、`delay` で試行間隔を秒単位で指定できます。

以下は、Web サーバーの起動を確認するまで最大 5 回、10 秒間隔で繰り返すプレイブックの例です：

```yaml
---
- name: Check if the web server is running.
  hosts: localhost
  gather_facts: false
  connection: ansible.builtin.local
  tasks:
    - name: Check if the web server is running.
      ansible.builtin.command:
        cmd: systemctl is-active httpd
      register: result
      until: result.stdout == 'active'
      retries: 5
      delay: 10
```

[不定回の繰り返し](https://zenn.dev/y_mrok/books/ansible-no-tsukaikata/viewer/chapter13#%E4%B8%8D%E5%AE%9A%E5%9B%9E%E3%81%AE%E7%B9%B0%E3%82%8A%E8%BF%94%E3%81%97)

はい、Web サーバーの起動確認についてより実用的な例を示します。

以下は、Nginx をインストールして起動し、サービスが完全に起動するまで待機する実践的な例です：

```yaml
---
- name: Deploy and verify Nginx
  hosts: web_servers
  become: true
  tasks:
    - name: Install nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: yes

    - name: Start nginx service
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: yes

    - name: Wait for Nginx to be ready
      ansible.builtin.uri:
        url: "http://localhost"
        return_content: yes
      register: result
      until: result.status == 200
      retries: 6 # 合計60秒待機
      delay: 10 # 10秒間隔
      failed_when: false # 初期の失敗を許容

    - name: Verify Nginx configuration
      ansible.builtin.command:
        cmd: nginx -t
      register: nginx_config
      changed_when: false
```

このプレイブックの特徴：

1. Nginx のインストールと起動を行います
2. `uri`モジュールを使って実際に HTTP リクエストを送信し、サービスが応答するまで待機します
3. 最大 60 秒（10 秒 × 6 回）待機します
4. 設定ファイルの構文チェックも行います

より高度な例として、HTTPS の確認やカスタムページの存在確認を含めた版：

```yaml
---
- name: Deploy and verify Nginx with advanced checks
  hosts: web_servers
  become: true
  vars:
    site_url: "http://{{ ansible_host }}"
    expected_response: "Welcome to nginx"
  tasks:
    - name: Install nginx
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: yes

    - name: Start nginx service
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: yes

    - name: Wait for Nginx to be fully operational
      block:
        - name: Check HTTP response
          ansible.builtin.uri:
            url: "{{ site_url }}"
            return_content: yes
          register: result
          until:
            - result.status == 200
            - expected_response in result.content
          retries: 6
          delay: 10
      rescue:
        - name: Check Nginx error logs
          ansible.builtin.command:
            cmd: tail -n 20 /var/log/nginx/error.log
          register: error_log

        - name: Display error logs
          ansible.builtin.debug:
            var: error_log.stdout_lines

        - name: Fail with meaningful message
          ansible.builtin.fail:
            msg: "Nginxの起動確認に失敗しました。エラーログを確認してください。"
      always:
        - name: Verify Nginx process
          ansible.builtin.command:
            cmd: pgrep nginx
          changed_when: false
```

この高度な例の特徴：

1. `block`/`rescue`/`always`を使用してエラーハンドリングを実装
2. エラー時に Nginx のログを確認
3. 期待される応答内容も確認
4. プロセスの存在確認も実施

これらの例は実際の本番環境でより信頼性の高いデプロイメントを実現できます。

## 条件分岐で制御するディレクティブ

### `when` 指定した条件が成立した時に実行する

when ディレクティブを使用して、タスクを実行する時の条件を設定できる。タスクは指定した条件が成立したときだけ実行する。

```yaml
---
- name: Check if the web server is running.
  hosts: localhost
  gather_facts: false
  connection: ansible.builtin.local
  tasks:
    - name: Check if the web server is running.
      ansible.builtin.command:
        cmd: systemctl is-active httpd
      when: result.stdout == 'active'
```

#### 比較演算子

<Table
  colWidth={["8rem", "auto"]}
  columns={["比較演算子", "説明"]}
  data={[
    ["A == B", "A と B が等しい"],
    ["A != B", "A と B が等しくない"],
    ["A > B", "A が B より大きい"],
    ["A >= B", "A が B 以上"],
    ["A < B", "A が B より小さい"],
    ["A <= B", "A が B 以下"],
  ]}
/>

##### 比較演算子の使用例

使用されている OS が ubuntu の時は、ubuntu のパッケージをインストールするプレイブック。
nginx のインストールは、ubuntu と rhel ではパッケージ名が異なるため、when ディレクティブを使用して分岐する。

```yaml
---
- name: Install Nginx
  hosts: localhost
  tasks:
    - name: Install Nginx
      ansible.builtin.apt:
        name: nginx
        state: present
      when: ansible_os_family == 'Debian'
```

#### 論理演算子

<Table
  colWidth={["8rem", "auto"]}
  columns={["論理演算子", "説明"]}
  data={[
    ["A and B", "A と B が成立"],
    ["A or B", "A または B が成立"],
    ["not A", "A が成立しない"],
  ]}
/>

##### 論理演算子の使用例

条件式を結合した例として、RedHat 系の OS かつ、メジャーバージョンが 8 以上の時に、管理対象のノードだけリブートする。

```yaml
---
- name: Reboot the managed node.
  hosts: all
  become: yes

  tasks:
    - name: Only RedHat and major version 8 will reboot.
      ansible.builtin.reboot:
      when: ansible_facts['os_family'] == "RedHat" and ansible_facts['distribution_major_version'] == "8"
```

when 内の and 以下のように書くこともできる。

```yaml
when: ansible_facts['os_family'] == "RedHat"
  and ansible_facts ['distribution_major_version'] == "8"
```

```yaml
when:
  - ansible_facts['os_family'] == "RedHat"
  - ansible_facts ['distribution_major_version'] == "8"
```

A かつ B または C の場合は、

```yaml
when: ansible_facts['os_family'] == "RedHat"
  and ansible_facts ['distribution_major_version'] == "8"
  or ansible_facts ['distribution_major_version'] == "9"
```

`()` を使用して、条件式を書くこともできる。

```yaml
when: ansible_facts['os_family'] == "RedHat"
  and (ansible_facts ['distribution_major_version'] == "8" or
  ansible_facts ['distribution_major_version'] == "9")
```

`()`を同等の条件ブロック同士でグループ指定することも考えて書く

```yaml
when: (ansible_facts['os_family'] == "RedHat" )
  and (ansible_facts ['distribution_major_version'] == "8" or
  ansible_facts ['distribution_major_version'] == "9")
```

##### not を使用した例

RedHat 系の OS ではない場合に、パッケージをインストールするプレイブック。

```yaml
---
- name: Install Nginx
  hosts: localhost
  tasks:
    - name: Install Nginx
      ansible.builtin.apt:
        name: nginx
        state: present
      when: not ansible_facts['os_family'] == "RedHat"
```

#### in / not in

<Table
  colWidth={["8rem", "auto"]}
  columns={["in", "説明"]}
  data={[
    [["A in B", "A in [B, C, D]"].join("<br/>"), "A が B に含まれる"],
    [["A not in B", "A not in [B, C, D]"].join("<br/>"), "A が B に含まれない"],
  ]}
/>

```yaml
---
- name: Install Nginx
  hosts: localhost
  tasks:
    - name: Install Nginx
      ansible.builtin.apt:
        name: nginx
        state: present
      when: ansible_facts['os_family'] in ["Debian", "Ubuntu"]
```

### `block`、`rescue`、`always` 例外処理で対応する

```yaml
---
- hosts: all
  vars:
    ansible_become: yes
    ansible_become_method: sudo
  tasks:
    - name: Install Nginx
      block:
        - yum:
            name: nginx
            state: latest
      rescue:
        - debug:
          msg: "Error!"
      always:
        - debug:
          msg: "Always run this section"
```

プレイブック内で block を指定すると、block 内でのエラーが発生した場合、rescue ブロックが処理される。いわゆる例外処理を行う。
単に block の処理にエラーが起きると failed とせず、rescue を行う(エラーハンドリング)。

#### block

このセクションに実行するタスクを記述して、以降の rescue、always のセクションはこの block の処理次第で実行される。

#### rescue

block 内の処理でエラーが発生した際に、このセクションに記述されている処理が実行される。

#### always

block 内の処理が終了した際、タスクの成功、失敗に問わず必ず実行される。
ここでは、block 内の処理が成功した場合は、"Always run this section" という文字が出力されエラーが発生した場合は rescue 内の "Error!"
が出力された後に、"Always run this section" の文字が出力される。

## 実行結果で制御を行う

### register

`register` ディレクティブは、利用しているタスクブロックの実行結果をオブジェクトとして変数に格納することができる。
また、`register` で定義した変数は後続のタスクで参照・利用することができる。
これにより動的なプレイブックの処理を実現し、条件分岐、デバッグなどを行うことができる。

#### register の使用例

主な register の用途は以下のように鳴ります。

- タスク結果の保存: コマンドやモジュールの実行結果を変数に保存。
- 条件分岐: 保存した結果に基づいてタスクの実行を制御。
- デバッグ: 実行結果を確認し、問題の特定を支援。
- ループ処理: 複数のアイテムに対して繰り返し処理を行い、その結果を管理。

これらの機能を活用して、Ansible プレイブックの柔軟性と効率性を向上させましょう。

#### 参考

<LinkPreview url="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#registering-variables" />
<LinkPreview url="https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.html" />

#### シンプルなコマンドの実行結果を登録する

```yaml
---
- name: シンプルなコマンド結果の登録
  hosts: all
  gather_facts: false

  tasks:
    - name: ホストの現在の日時を取得
      ansible.builtin.command:
        cmd: date
      register: current_date # 実行結果を変数に格納

    - name: 取得した日時を表示
      ansible.builtin.debug:
        # register で定義した変数を参照
        msg: "現在の日時は {{ current_date.stdout }} です。"
```

こちらの実行結果は以下の通り。

```
PLAY [シンプルなコマンド結果の登録] **********************************************************************

TASK [ホストの現在の日時を取得] ******************************************************************************
changed: [web01]

TASK [取得した日時を表示] ********************************************************************************
ok: [web01] => {
    "msg": "現在の日時は Wed Jan 15 13:05:08 UTC 2025 です。"
}

PLAY RECAP ***********************************************************************************************
web01                      : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

#### 条件分岐に利用する

リモートホスト上に特定のファイルが存在するかどうかを確認し、その結果に基づいて異なるタスクを実行します。

```yaml
---
- name: ファイル存在確認と条件分岐
  hosts: all
  gather_facts: false

  tasks:
    - name: 特定のファイルが存在するか確認
      ansible.builtin.stat:
        path: /etc/passwd
      register: passwd_file

    - name: ファイルが存在する場合のメッセージ
      ansible.builtin.debug:
        msg: "/etc/passwd ファイルが存在します。"
      when: passwd_file.stat.exists

    - name: ファイルが存在しない場合のメッセージ
      ansible.builtin.debug:
        msg: "/etc/passwd ファイルが存在しません。"
      when: not passwd_file.stat.exists
```

こちらの実行結果は以下の通り。

```
PLAY [ファイル存在確認と条件分岐] ***********************************************************************************

TASK [特定のファイルが存在するか確認] **************************************************************************
ok: [web01]

TASK [ファイルが存在する場合のメッセージ] ************************************************************************
ok: [web01] => {
    "msg": "/etc/passwd ファイルが存在します。"
}

TASK [ファイルが存在しない場合のメッセージ] ********************************************************************
skipping: [web01]

PLAY RECAP *****************************************************************************************************
web01                      : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0
```

#### サービスの状態を取得し、再起動を行う

リモートホスト上のサービスの状態を取得し、必要に応じてサービスを再起動します。

```yaml
---
- name: サービスの状態取得と再起動
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: nginx サービスの状態を取得
      ansible.builtin.systemd:
        name: nginx
        state: status
      register: nginx_status # サービスの状態を変数に格納

    - name: nginx サービスがアクティブでない場合に再起動
      ansible.builtin.systemd:
        name: nginx
        state: restarted
      when: not nginx_status.status.ActiveState == "active"

    - name: nginx サービスの再起動結果を表示
      ansible.builtin.debug:
        msg: "nginx サービスを再起動しました。"
      when: not nginx_status.status.ActiveState == "active"
```

実行結果例（サービスがアクティブでない場合）

```
PLAY [サービスの状態取得と再起動] *******************************************************************************

TASK [nginx サービスの状態を取得] **********************************************************************************
ok: [web01]

TASK [nginx サービスがアクティブでない場合に再起動] ******************************************************************
changed: [web01]

TASK [nginx サービスの再起動結果を表示] ****************************************************************************
ok: [web01] => {
    "msg": "nginx サービスを再起動しました。"
}

PLAY RECAP *****************************************************************************************************
web01                      : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

#### 条件付き処理とループ内での register の使用

複数のサービスの状態を取得し、それぞれの状態に基づいて必要なアクションを実行します。

```yaml
---
- name: 複数サービスの状態確認とアクション
  hosts: all
  become: true
  gather_facts: false

  vars:
    services:
      - nginx
      - mysql
      - redis

  tasks:
    - name: 各サービスの状態を取得
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: status
      loop: "{{ services }}"
      register: services_status # サービスの状態を変数に格納

    - name: 非アクティブなサービスを再起動
      ansible.builtin.systemd:
        name: "{{ item.item }}"
        state: restarted
      loop: "{{ services_status.results }}"
      when: not item.status.ActiveState == "active"
      register: restarted_services # 再起動したサービスを変数に格納

    - name: 再起動したサービス一覧を表示
      ansible.builtin.debug:
        msg: "再起動されたサービス: {{ restarted_services.results | map(attribute='item.item') | list }}"
      when: restarted_services is defined and restarted_services.results | length > 0 # 再起動したサービスがある場合
```

実行結果例（いくつかのサービスが非アクティブの場合）

```
PLAY [複数サービスの状態確認とアクション] ***************************************************************************

TASK [各サービスの状態を取得] *******************************************************************************************
ok: [web01] => (item=nginx)
ok: [web01] => (item=mysql)
ok: [web01] => (item=redis)

TASK [非アクティブなサービスを再起動] *********************************************************************************
changed: [web01] => (item={'item': 'redis', 'status': {...}})

TASK [再起動したサービス一覧を表示] *************************************************************************************
ok: [web01] => {
    "msg": "再起動されたサービス: ['redis']"
}

PLAY RECAP *****************************************************************************************************
web01                      : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

#### コマンド実行結果に基づく条件分岐と変数の活用

特定のコマンドの実行結果を取得し、その結果に基づいて後続のタスクを制御します。

```yaml
---
- name: コマンド実行結果に基づく処理
  hosts: all
  gather_facts: false

  tasks:
    - name: ディスク使用量を確認
      ansible.builtin.command:
        cmd: df -h / | tail -1 | awk '{print $5}' | tr -d '%'
      register: disk_usage

    - name: ディスク使用量を表示
      ansible.builtin.debug:
        msg: "ルートディスクの使用率は {{ disk_usage.stdout }}% です。"

    - name: ディスク使用率が80%以上の場合に警告を表示
      ansible.builtin.debug:
        msg: "警告: ルートディスクの使用率が80%を超えています。"
      when: disk_usage.stdout | int >= 80
```

実行結果例（ディスク使用率が 85%の場合）

```
PLAY [コマンド実行結果に基づく処理] *************************************************************************************

TASK [ディスク使用量を確認] ***********************************************************************************************
changed: [web01]

TASK [ディスク使用量を表示] *********************************************************************************************
ok: [web01] => {
    "msg": "ルートディスクの使用率は 85% です。"
}

TASK [ディスク使用率が80%以上の場合に警告を表示] ***********************************************************************
ok: [web01] => {
    "msg": "警告: ルートディスクの使用率が80%を超えています。"
}

PLAY RECAP *****************************************************************************************************
web01                      : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```
