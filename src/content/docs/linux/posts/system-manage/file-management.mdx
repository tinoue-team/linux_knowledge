---
title: ファイル権限の運用管理
description: ファイル権限や、チーム運用
tags:
  - "Linux"
  - "System Management"
sidebar:
  # このリンクのカスタムラベルを設定します
  label: ファイル権限の運用管理
  # このリンクの順番をカスタマイズします（数字が小さいほど上に表示されます）
  order: 2
  # このリンクにバッジを追加します
  # badge:
  #     text: ""
  #     variant: tip
---

import { LinkCard, Tabs, TabItem } from "@astrojs/starlight/components";
import LinkPreview from "@components/LinkPreview.astro";
import Table from "@components/Table.astro";

## ファイルの権限操作

### ファイル権限操作関連のコマンド

<Table
  caption="ファイル・ディレクトリのアクセス権限操作"
  columns={["コマンド", "説明"]}
  data={[
    ["chmod", ""],
    ["chown", ""],
    ["chgrp", ""],
  ]}
/>

<Table
  caption="所有者・所有者グループに関する操作"
  columns={["コマンド", "説明"]}
  data={[
    ["groupadd", "グループを作成する"],
    ["groupdel", "グループを削除する"],
    ["groupmod", "グループ情報を変更する"],
  ]}
/>

### What permission

パーミッション(permission)とは、ファイルやディレクトリに設定されているアクセス許可の権限のことです。
つまり、対象のファイル・ディレクトリには見る・書く・実行するのそれぞれの許可が設定されています。確認するには以下。

```bash frame=none
ls -la | grep git
 drwxr-xr-x   15    t_inoue    staff   480   6 25 23:54  .git
 -rw-r--r--    1    t_inoue    staff     7   6 30 04:43  .gitignore
└─────┬────┘ └─┬─┘ └───┬───┘  └──┬──┘ └─┬─┘ └─────┬────┘ └─────┬───┘
      1        2       3         4      5         6            7
```

1. **ファイルタイプとアクセス権**

   最初の一文字目はファイルタイプ（d はディレクトリ、-は通常のファイル、l はシンボリックリンク）
   ファイルタイプ以降の文字は 9 文字でアクセス権を示している

   <Table
     caption="例えば、アクセス権が `rwxr-xr-x` の場合"
     columns={["権限", "説明"]}
     data={[
       ["rwx", "アクセス権 1 ~ 3 文字目まで**所有者**の権限（読み・書き・実行）"],
       ["r-x", "アクセス権 4 ~ 6 文字目まで**グループ**の権限（読み・実行）"],
       ["r-x", "アクセス権 7 ~ 9 文字目まで**他のユーザー**の権限（読み・実行）"],
     ]}
   />

1. **ハードリンクの数**

   ハードリンクの数（ディレクトリの場合はサブディレクトリと親ディレクトリのリンクを含む）

1. **所有者**

   ファイルまたはディレクトリの所有者

1. **所有グループ**

   ファイルまたはディレクトリの所有グループ

1. **ファイル・ディレクトリのサイズ**

   ファイルまたはディレクトリのサイズ（バイト単位）

1. **タイムスタンプ**

   最終更新日時

   <Table
     caption="`6 25 23:54` の場合"
     colWidth={["6rem", "6rem"]}
     columns={["フィールド", "説明"]}
     data={[
       ["6", "月"],
       ["25", "日"],
       ["23:54", "時刻(時:分)"],
     ]}
   />

1. **ファイル名**

### アクセス権

ファイルとディレクトリで、アクセス権が設定されている場合、それぞれのアクセス権の理解は以下です。

<Table
  columns={["アクセス権", "ファイルのアクセス権の説明", "ディレクトリのアクセス権の説明"]}
  data={[
    [
      "r (読み取り可能)",
      ["ファイルの内容を読み取ることができる"].join("<br>"),
      "ディレクトリ内のファイル一覧を表示することができる",
    ],
    [
      "w (書き込み可能)",
      ["ファイルの内容を変更できる", "ファイルを削除できる"].join("<br>"),
      "ディレクトリ内でファイルの作成・削除ができる",
    ],
    ["x (実行可能)", ["ファイルを実行することができる"].join("<br>"), "ディレクトリ内のファイルにアクセスできる"],
  ]}
/>

#### アクセス権の表記(権限の範囲)

アクセス権はアルファベットで、r, w, x で表記できるが、これを数値で表すことができる。
r(読み込み) は 4、w(書き込み) は 2、x(実行) は 1

<Table
  columns={["数値", "権限", "説明"]}
  data={[
    ["0", "`---`", "権限なし"],
    ["1", "`--x`", "実行権限のみ(only exec)"],
    ["2", "`-w-`", "書き込みのみ(only write)"],
    ["3", "`-wx`", "書き込み、実行(write and exec)"],
    ["4", "`r--`", "読み込みのみ(only read)"],
    ["5", "`r-x`", "読み込み、実行(read and exec)"],
    ["6", "`rw-`", "読み込み、書き込み(read and write)"],
    ["7", "`rwx`", "すべての権限(read and write and exec)"],
  ]}
/>

:::note[デフォルトのアクセス権値]

デフォルトのアクセス権については [umask](/linux/cmd/security/umask/) を参照

:::

ファイルのアクセス権の設定については [chmod](/linux/cmd/security/chmod/) を参照

:::tip[ssh キーのアクセス権設定]

ssh 接続する際の秘密鍵ファイルについては他のユーザやグループにアクセス権限を設定しているとエラーとなってしまう。
そのため、400 や 600、つまりオーナー権限のみの読み取りのみまたは読み取り、書き込みまでの権限とする。

```bash frame=none
chmod 400 ~/.ssh/secret_key.pem
```

:::

#### アクセス権 `s` について

##### SUID (Set User ID)

`passwd` コマンドを使うことにより、一般ユーザは自分自身のパスワードを変更できる。パスワードの変更は `/etc/shadow` ファイルに保存される。

```bash frame=none
ls -l /etc/shadow
-rw-r----- 1 root shadow 502 Jun  5 02:23 /etc/shadow
```

`/etc/shadow` ファイル自体はファイルの所有者とアクセス権は、一般ユーザが書き込めないパーミッションになっている。

`passwd` コマンドの実行ファイルのアクセス権は以下のようになっている。

```bash frame=none
ls -l /usr/bin/passwd
-rwsr-xr-x 1 root root 72056 Apr  9 07:01 /usr/bin/passwd
```

所有者のアクセス権 `rws` は実行権が `x` ではなく、`s` になっている。これは実行権をもっているユーザによって`passwd` が実行された場合は、root 権限で実行されることを意味する。これを SUID (Set User ID) という。つまり、`passwd` コマンドが一般ユーザによって実行された場合には root の権限で、`/etc/shadow` ファイルに書き込むことができる。

SUID を使った場合、所有者の実行権欄が `s` になります。数値で実現するには、3 桁のアクセス権表記に `4000` を加える。今回の `/usr/bin/passwd` の場合、「4755」と表現できる。

##### SGID (Set Group ID)

グループの実行権限が `s` になるようにする。その場合、3 桁のアクセス権表記に 2000 を加える

```bash frame=none
chmod g+s samplefile
```

#### スティッキービット(アクセス権 `t`)

<LinkPreview url="https://kazmax.zpp.jp/linux_beginner/stickybit.html" type="inline" />

スティッキービットが設定されたディレクトリはすべてのユーザがファイルの作成・書き込みが可能です。
777 の権限との違いは、作成したファイルやディレクトリを削除出来るのは所有者のみです。(root ユーザは所有者じゃなくても可能)

スティッキービットが適応されているディレクトリは /tmp が身近な例です。その他ユーザの実行権限が `t` となります。

```bash frame=none
ls -ld /tmp
drwxrwxrwt 1 root root 512 Dec 12 16:56 /tmp
#        ↑ ここ
```

スティッキービットが設定されていることにより、所有者(と root)以外のユーザが作成したファイルを削除することができなくなります。スティッキービットは 3 桁のアクセス権表記に 1000 を加えた表記です。

chmod でスティッキービットを設定するには

```bash frame=none
chmod o+t testdir
```

## 所有グループとは
