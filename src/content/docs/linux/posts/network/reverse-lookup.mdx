---
title: 逆引き(reverse DNS lookup)
description: 逆引きについての設定方法
tags:
    - "Linux"
    - "Network"
sidebar:
    # このリンクのカスタムラベルを設定します
    label: 逆引き(reverse DNS lookup)
    # このリンクの順番をカスタマイズします（数字が小さいほど上に表示されます）
    order: 2
    # このリンクにバッジを追加します
    # badge:
    #     text: ""
    #     variant: tip
---

import { LinkCard, Tabs, TabItem } from "@astrojs/starlight/components";
import LinkPreview from "@components/LinkPreview.astro";
import Table from "@components/Table.astro";

## 逆引きの手順

### 逆引きについて

目的のアドレスの逆引き設定を行う。逆引きの設定後は以下のような実行結果となる

```bash frame=none
nslookup 15.0.1.10
10.1.0.15.in-addr.arpa  name = example.com.
```

:::note[逆引きが設定されていないと]

逆引きが設定されていないと以下のような標準出力が返される。

```bash frame=none
nslookup 15.0.1.10
** server can't find 10.1.0.15.in-addr.arpa: NXDOMAIN
```

:::

#### 逆引きの DNS レコードについて

逆引きの対象となる IP アドレスが `15.0.1.10` のようになっていた場合、登録するレコード名はオクテット毎に分けた数字が逆に並ぶ。

```
15.0.1.10 → 10.1.0.15
```

さらに、末尾に `.in-addr.arpa` を付けた形式が逆引きレコードとなる

```
10.1.0.15.in-addr.arpa
```

### AWS で逆引き用ホストゾーンを作成

利用する回線の帯域に応じて、ホストゾーンのドメイン名が変わってくる。
ドメイン名はサブネットによって変更される。

<Table
    caption=""
    columns={["サブネット", "ドメイン名"]}
    data={[
        ["/32 ~ /24", "`1.0.15.in-addr.arpa`"],
        ["/23 ~ /16", "`0.15.in-addr.arpa`"],
        ["/15 ~ /8", "`15.in-addr.arpa`"],
    ]}
/>

#### CLI でのホストゾーン登録処理

```bash frame=none
# ホストゾーン名をサブネットに合わせて設定
DOMAIN="0.15.in-addr.arpa"
COMMENT="目的に応じたコメントを用意する"

HOSTED_ZONE_ID=$(aws route53 create-hosted-zone \
    --name "$DOMAIN" \
    --caller-reference "$(date +%s)" \
    --hosted-zone-config '{"Comment":"'"$COMMENT"'", "PrivateZone":false}' \
    --query "HostedZone.Id" --output text) && echo "$HOSTED_ZONE_ID"
```

重複したホストゾーンが登録されてしまったら、NS と SOR のレコード以外すべて削除してから、不要になったホストゾーンを削除する。

### AWS で登録したホストゾーンに逆引きレコードを追加する

逆引きのトラフィックルーティングの値を決めるために、正引きの DNS レコードを知っている必要がある。  
正引きのレコード名と逆引きのトラフィックルーティングの値を一致させることで、正引き、逆引きが対応することになる。

正引きのレコード名: `15-0-1-10.example.com`

逆引きので設定される値は以下のようになる

<Table
    caption=""
    columns={["レコード名", "タイプ", "値/トラフィックのルーティング先"]}
    data={[["10.1.0.15.in-addr.arpa", "PTR", "15-0-1-10.example.com"]]}
/>

さらにこれに TTL 値などが追加指定することができる。

#### AWS CLI でのレコード作成

```bash frame=none
WAN_IP="15.0.1.10"
SUBNET="22"
REVERSE_DOMAIN="example.com"


IFS='.' read -r -a ip_octet_list <<<"$WAN_IP"

# レコード名
dns_record="${ip_octet_list[3]}.${ip_octet_list[2]}.${ip_octet_list[1]}.${ip_octet_list[0]}.in-addr.arpa"
# 値/トラフィックのルーティング先
routing_param="${ip_octet_list[0]}-${ip_octet_list[1]}-${ip_octet_list[2]}-${ip_octet_list[3]}.$REVERSE_DOMAIN"

echo "登録するDNSレコード: $dns_record"

if [ "$SUBNET" -gt 23 ]; then
    dns_name="${ip_octet_list[2]}.${ip_octet_list[1]}.${ip_octet_list[0]}.in-addr.arpa"
elif [ "$SUBNET" -gt 15 ]; then
    dns_name="${ip_octet_list[1]}.${ip_octet_list[0]}.in-addr.arpa"
else
    echo "一般的なサブネットの枠より大きいです。"
    dns_name="${ip_octet_list[0]}.in-addr.arpa"
fi

zone_id=$(aws route53 list-hosted-zones-by-name \
    --dns-name "$dns_name" \
    --query "HostedZones[?Name == \`${dns_name}.\`].Id | [0]" \
    --output text) && echo "zone_id: $zone_id"

# DDNS登録処理***************************************************************************************
if [ "$WAN_IP" = '' ]; then
    echo "登録対象 IP 取得失敗: DDNS登録NG"
elif [ "$REVERSE_DOMAIN" = '' ]; then
    echo "逆引きドメインが指定されていません: DDNS登録NG"
elif [ "$zone_id" = '' ]; then
    echo "zone_id 取得失敗: DDNS登録NG"
else
    # DDNS処理ファイル作成処理開始
    aws route53 \
        change-resource-record-sets \
        --hosted-zone-id "${zone_id}" \
        --change-batch '{
            "Changes": [
                {
                "Action": "UPSERT",
                "ResourceRecordSet": {
                    "Name": "'"${dns_record}"'",
                    "ResourceRecords": [
                    {
                        "Value": "'"${routing_param}"'"
                    }
                    ],
                    "TTL": 3600,
                    "Type": "PTR"
                }
                }
            ]
        }'

    echo "登録完了: $dns_record" # 戻り値
fi

```

正引きの設定が完了して、逆引きのレコード設定が反映されれば、目的の IP の逆引きが行われる。(ほかにも作成したホストゾーンで対応するネームサーバーの指定も変更する必要が出てくきます。)

作成後、`dig` や `nslookup` で逆引きが反映されているか確認する

```bash frame=none
nslookup 15.0.1.10
```

:::tip[nslookup ツール]
nslookup や dig をインストールしなくてもブラウザのサービスがあるので、これを利用して正引き、逆引きの確認しても良さそう。

<LinkPreview url="https://www.cman.jp/network/support/nslookup.html" />

:::
