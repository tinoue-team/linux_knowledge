---
title: postmulti
description: postfix マルチインスタンスの管理ツール
tags:
    - "メール管理"
sidebar:
    # このリンクのカスタムラベルを設定します
    label: postmulti
    # このリンクの順番をカスタマイズします（数字が小さいほど上に表示されます）
    order: 2
    # このリンクにバッジを追加します
    # badge:
    #     text: ""
    #     variant: tip
---

import { LinkCard, Tabs, TabItem } from "@astrojs/starlight/components";
import LinkPreview from "@components/LinkPreview.astro";
// import MermaidChart from "@components/MermaidChart.astro";
import Table from "@components/Table.astro";

## 概要

<LinkPreview url="https://hp.vector.co.jp/authors/VA022911/tec/centos/postfix_multi_instance.htm" />
<LinkPreview url="https://docs.oracle.com/cd/E62101_01/html/E62874/postmulti-1.html" />
<LinkPreview url="https://qiita.com/amedama/items/79c8e4e0714e1676e99b" />

## 基本

### 説明

Postfix マルチインスタンスの管理ツール

`postmulti`コマンドは、Postfix 管理者が一つのホスト上で複数の Postfix インスタンスを管理することを可能にします。

-   iterator mode …複数の Postfix インスタンスに対して同じコマンドを実行する
-   life-cycle management mode …一つのインスタンスを追加・削除・状態を変更したりします。

それぞれの動作モードには独自のコマンド構文があります。このため、それぞれのモードについて、以下に別々のセクションで説明します。

### 構文

#### Enabling multi-instance management (マルチインスタンス管理の有効化)

```bash
postmulti -e init [-v]
```

#### Iterator mode

```bash
postmulti -l [-aRv] [-g group] [-i name]

postmulti -p [-av] [-g group] [-i name] postfix-command...

postmulti -x [-aRv] [-g group] [-i name] unix-command...
```

#### Life-cycle management mode

```bash
postmulti -e create [-av] [-g group] [-i name] [-G group] [-I name] [param=value ...]

postmulti -e import [-av] [-g group] [-i name] [-G group] [-I name] [config_directory=/path]

postmulti -e destroy [-v] -i name

postmulti -e deport [-v] -i name

postmulti -e enable [-v] -i name

postmulti -e disable [-v] -i name

postmulti -e assign [-v] -i name [-I name] [-G group]
```

### 背景

マルチインスタンス構成は、1 つのプライマリ Postfix インスタンスと、1 つ以上のセカンダリインスタンスから構成され、セカンダリインスタンスの設定ディレクトリのパスはプライマリインスタンスの `main.cf` ファイルに記録されます。
Postfix インスタンスはプログラムファイルやドキュメントを共有しますが、各インスタンスは独自の設定、キュー、データディレクトリを持ちます。

現在、デフォルトの Postfix インスタンスのみがマルチインスタンス構成においてプライマリインスタンスとして使用可能です。
`postmulti(1)` コマンドは、代替のプライマリインスタンスを選択するための `-c` オプションをサポートしておらず、`MAIL_CONFIG` 環境変数にデフォルトでない設定ディレクトリが設定されている場合は致命的なエラーを出して終了します。

マルチインスタンスの管理についての詳細は、`MULTI_INSTANCE_README` チュートリアルを参照してください。

## オプション

### ITERATOR MODE

`postmulti` はすべての Postfix インスタンスに対して順番に同じ操作を実行します。

マルチインスタンスサポートが有効でない場合、指定されたコマンドはプライマリインスタンスのみに対して実行されます。

イテレーターモードでは以下のコマンドオプションが使用できます：

インスタンスの選択

<Table
    caption="ITERATOR MODE OPTION"
    columns={["Option", "Description"]}
    data={[
        ["-a", "すべてのインスタンスに対して操作を実行します。これはデフォルトの動作"],
        ["-g <i>group<i>", "指定された group のメンバーに対してのみ操作を実行"],
        [
            "-i <i>name<i>",
            [
                "指定された name のインスタンスに対してのみ操作を実行します。",
                "",
                "インスタンス名またはインスタンスの設定ディレクトリの絶対パスを指定できます。",
                "name に - を指定するとプライマリ Postfix インスタンスが選択されます",
            ].join("<br>"),
        ],
        [
            "-R",
            [
                "イテレーションの順序を逆にします(Revert)。",
                "これは「シンク」インスタンスを「ソース」インスタンスよりも先に開始するようなマルチインスタンスシステムの更新時に適しています",
                "<span style='color: orange'>このオプションは `-p` と一緒に使用することはできません</span>",
            ].join("<br>"),
        ],
    ]}
/>

:::note[summaty]
イテレーターモードでは、複数の Postfix インスタンスに対して同じ操作を連続して実行する際に便利です。

-   `-a` を使うとすべてのインスタンスに、
-   `-g` で特定のグループ内のインスタンスに、
-   `-i` で特定のインスタンスのみに操作を実行します。

また、`-R` を使うことで、処理の順序を逆にすることも可能です。
:::

### List mode

<Table
    caption="LIST MODE OPTION"
    columns={["Option", "Description"]}
    data={[
        [
            "-l",
            ["インスタンス名、グループ名、enable/disable の状態、設定ファイルディレクトリなどの情報が表示される"].join(
                "<br>"
            ),
        ],
    ]}
/>

#### 使用例

```bash
postmulti -l
-               -               y         /etc/postfix
postfix-es5     -               y         /etc/postfix-es5
postfix-zqt     -               y         /etc/postfix-zqt
postfix-sap     -               y         /etc/postfix-sap
postfix-tr3     -               y         /etc/postfix-tr3

postmulti -i postfix-zqt -e disable
postmulti -l
-               -               y         /etc/postfix
postfix-es5     -               y         /etc/postfix-es5
postfix-zqt     -               n         /etc/postfix-zqt
postfix-sap     -               y         /etc/postfix-sap
postfix-tr3     -               y         /etc/postfix-tr3
```

### Postfix-wrapper mode

Postfix-wrapper mode は、postmulti がラッパーとして postfix コマンドを実行する際に使用されます。  
このモードでは、特定のインスタンスやグループに対して start、stop、reload などの操作を行うことができ、
postmulti のパラメータでコマンドをカスタマイズ可能です。

```bash
-p postfix-command
```

```bash frame=none
postmulti -i postfix-xxx -p start # インスタンスの稼働
postmulti -i postfix-xxx -p reload # インスタンス設定の再読み込み
postmulti -i postfix-xxx -p status # インスタンスの状態確認
postmulti -i postfix-xxx -p stop # インスタンスの停止
```

`postfix(1)` を呼び出して `postfix-command` を実行します。このオプションは `postfix-wrapper(5)` インターフェースを実装します。

-   「start」系のコマンドの場合、有効化されていないインスタンスに対して "postfix check" が実行されます。コマンドの完全なリストは `postmulti_start_commands` パラメータで指定されます。
-   「stop」系のコマンドの場合、イテレーションの順序が逆になり、無効化されているインスタンスはスキップされます。コマンドの完全なリストは `postmulti_stop_commands` パラメータで指定されます。
-   「reload」や開始済みのインスタンスを必要とするその他のコマンドの場合、無効化されているインスタンスはスキップされます。コマンドの完全なリストは `postmulti_control_commands` パラメータで指定されます。
-   「status」や、開始済みのインスタンスを必要としない他のコマンドの場合、すべてのインスタンスに対してコマンドが実行されます。

-p オプションは、指定されたインスタンスやインスタンスグループをインタラクティブに開始/停止するためにも使用できます。
たとえば、"msa" グループ内のインスタンスだけを開始するには、以下のように postmulti(1) を実行します：

```bash frame=none
postmulti -g msa -p start
```

#### 使用例

##### セカンダリインスタンスの状態確認

```bash frame=none
SECONDARY_COUNT=$(postmulti -l | grep -c postfix-)
# マルチインスタンスの状態確認
for i in $(seq 1 "$SECONDARY_COUNT"); do
    postmulti -i postfix-"$i" -p status
    postmulti -i postfix-"$i" -p reload
    postmulti -i postfix-"$i" -p start
done
```

##### マルチインスタンスの削除

```bash frame=none
SECONDARY_COUNT=$(postmulti -l | grep -c postfix-)
echo "$SECONDARY_COUNT"
# マルチインスタンスの状態確認
for i in $(seq 1 "$SECONDARY_COUNT"); do
    echo "postfix-$i を削除"
    postmulti -i postfix-"$i" -p stop
    postmulti -i postfix-"$i" -e disable
    postmulti -i postfix-"$i" -p status
    rm -rf /var/spool/postfix-"$i"
    postmulti -i postfix-"$i" -e destroy
done
```

### Command mode

```bash
-x unix-command
```

すべての Postfix インスタンスに対して指定された unix-command を実行します。  
このコマンドは、MAIL_CONFIG、command_directory、daemon_directory、config_directory、
queue_directory、data_directory、multi_instance_name、multi_instance_group、
および multi_instance_enable に適切な環境設定がされた状態で実行されます。

### Other options

<Table
    columns={["Option", "Description"]}
    data={[
        [
            "-v",
            [
                "デバッグ用に、冗長モードでのロギングを行う。マルチインスタンス構成における -v オプションはソフトウェアにますます冗長です。",
            ].join("<br>"),
        ],
    ]}
/>

## LIFE-CYCLE MANAGEMENT MODE

`-e` オプションを使用することで、postmulti(1) を用いて Postfix インスタンスを追加または削除したり、
既存のインスタンスのマルチインスタンスステータスを管理できます。

### Existing instance selection

<Table
    columns={["Option", "Description"]}
    data={[
        [
            "-a",
            [
                "インスタンスを作成またはインポートする際に、新しいインスタンスをセカンダリインスタンスリストの先頭に配置します。",
            ].join("<br>"),
        ],
        [
            "-g <i>group</i>",
            [
                "インスタンスを作成またはインポートする際に、指定したグループの最初のセカンダリインスタンスの前に新しいインスタンスを配置します。",
            ].join("<br>"),
        ],
        [
            "-i <i>name</i>",
            [
                "インスタンスを作成またはインポートする際に、一致するセカンダリインスタンスの前に新しいインスタンスを配置します。",
                "",
                "他のライフサイクル操作の場合、指定した既存インスタンスに対して操作を適用します。プライマリ Postfix インスタンスを選択するには、`-` を指定します",
            ].join("<br>"),
        ],
    ]}
/>

### New or existing instance name assignment

<Table
    columns={["Option", "Description"]}
    data={[
        [
            "-I <i>name</i>",
            [
                "Assign the specified instance name to an existing instance, newly-created instance, or imported instance.",
                "Instance names other than '-' (which makes the instance 'nameless') must start",
            ].join("<br>"),
        ],
        [
            "-G <i>group</i>",
            [
                "Assign the specified group name to an existing instance or to a newly created or imported instance.",
            ].join("<br>"),
        ],
    ]}
/>

### Instance creation/deletion/status change

管理対象インスタンスを「編集」する

```bash
postmulti -e action
```

<Tabs syncKey="instance-action-change">
    <TabItem label="init">
        `postmulti` を用いて Postfix インスタンスを管理する前にこのコマンドが必要です。
        `postmulti -e init` コマンドは、以下の設定をプライマリインスタンスの main.cf ファイルに追加して更新します：

        ```bash frame=none
        multi_instance_wrapper = ${command_directory}/postmulti -p --
        multi_instance_enable = yes
        ```
        これらの設定は、他の方法でも設定可能です。
    </TabItem>

    <TabItem label="create">
        新しい Postfix インスタンスを作成し、プライマリインスタンスの multi_instance_directories パラメータに追加します。
        インスタンスに短い名前を付ける `-I name` オプションの使用が推奨されます。
        これにより、新インスタンスのプライベートディレクトリのデフォルト値が構築されます。`-G group` オプションでグループに割り当てることも可能です。
        新しいインスタンスの main.cf は基本の main.cf で、共有ファイルの場所を指定する
        パラメータがプライマリインスタンスからコピーされます。「名前なし」のインスタンスの場合、`syslog_name` を手動で調整し、
        ログ内でインスタンスを識別できるようにします。`-I name` オプションで名前を割り当てる方が簡単です。

        オプションの "name=value" 形式で引数に
        `config_directory`、`queue_directory`、および `data_directory` を指定できます。

        > 例：

        ```bash
        postmulti -I postfix-mumble \
            -G mygroup -e create \
            config_directory=/my/config/dir \
            queue_directory=/my/queue/dir \
            data_directory=/my/data/dir
        ```

        これらのパスが指定されない場合は、
        プライマリインスタンスのパスの最後の要素を `-I` オプションの値に置き換えたパスを生成します。

        インスタンスの設定ディレクトリが既に存在し、main.cf および master.cf ファイルを含む場合、
        `create` コマンドはそのインスタンスを「そのままインポート」します。
        既存のインスタンスの場合、 `create` と `import` は同じ意味になります。

        > 使用例

        ```bash
        postmulti -I postfix-xxx -e create
        ```

        - `/etc/postfix-xxx`ディレクトリが作成され、中に子インスタンスの [main.cf](http://main.cf) と [master.cf](http://master.cf) が生成される。
        - ディレクトリ`/var/spool/postfix-xxx`や`/var/lib/postfix-xxx` が生成され、アクセス権が設定される

    </TabItem>

    <TabItem label="import">
        既存のインスタンスを postmulti(1) のマルチインスタンス管理対象にインポートします。
        これにより、インスタンスがプライマリインスタンスの multi_instance_directories リストに追加されます。
        `-I name` オプションが指定されている場合、新しいインスタンス名として機能し、
        インスタンス設定ディレクトリのデフォルトの場所が定義されます（上記 create と同様）。
        `-G group` オプションでグループに割り当てることが可能です。
        `config_directory=/path` 引数を追加して、`-I name` ベースのデフォルトパス名をオーバーライドできます。
    </TabItem>

    <TabItem label="destroy">
        セカンダリ Postfix インスタンスを削除します。
        削除対象となるインスタンスは、
        - 無効化されていて停止している
        - キューにメッセージがない状態
        プライマリ Postfix インスタンスを削除しようとすると致命的なエラーが発生し、削除されません。

        インスタンスはプライマリインスタンスの main.cf ファイルの alternate_config_directories パラメータから削除され、
        そのデータ、キュー、設定ディレクトリが Postfix システムによって作成されたファイルやディレクトリからクリーンアップされます。
        main.cf および master.cf ファイルは初期作成以降に変更があっても設定ディレクトリから削除されます。
        最後に、インスタンスは管理対象インスタンスリストから「削除」されます。

        インスタンスのプライベートディレクトリに他のファイルが存在する場合、完全に削除されない可能性があり、管理者に警告がログに記録されます。
        ディレクトリが「新しい」ものとして `create` アクションで作成されたインスタンスは、`disable` 後に `destroy` アクションで完全に削除されることが期待されます。
        設定やキューディレクトリにアクセスや書き換えテーブル、chroot 環境コンテンツなどの追加ファイルがある場合、インスタンスディレクトリは完全に削除されません。

        `destroy` アクションは、潜在的に危険なファイル削除操作を引き起こすため、
        インスタンスの `data`、`queue`、および `config` ディレクトリが正しく設定されており、
        貴重なファイルが含まれていないことを確認してください。
    </TabItem>

    <TabItem label="deport">
        セカンダリインスタンスを管理対象インスタンスリストから削除します。
        これにより、インスタンス設定ディレクトリが
        プライマリインスタンスの multi_instance_directories リストから削除されますが、
        ファイルやディレクトリは削除されません。
    </TabItem>

    <TabItem label="assign">
        インスタンスに新しい名前またはグループ名を割り当てます。
        `-G -` で「グループなし」、`-I -` で「名前なし」を指定できます。
        インスタンスを「名前なし」にする場合、対応する main.cf ファイルで適切な `syslog_name` を設定してください。
    </TabItem>

    <TabItem label="enable">
        選択されたインスタンスを有効化としてマークします。<br/>
        これは、インスタンスの main.cf ファイル内で `multi_instance_enable` パラメータを "yes" に設定するだけです。

        > 例：

        ```bash
        postmulti -i postfix-xxx -e enable # システムの起動後も自動でインスタンスが起動することを有効化
        ```

    </TabItem>

    <TabItem label="disable">
        選択されたインスタンスを無効化としてマークします。<br/>
        これにより、`postfix start`、 `postmulti -p start` などでインスタンスが開始されなくなります。<br/>
        インスタンスは、 `postfix -c config-directory start` などで引き続き開始可能です。<br/>

        > 例：

        ```bash
        postmulti -i postfix-xxx -e disable # システムの起動後も自動でインスタンスが起動することを無効化
        ```
    </TabItem>

</Tabs>

## ENVIRONMENT

postmulti(1) コマンドは、以下の環境変数をエクスポートします。

`MAIL_VERBOSE`  
-v コマンドラインオプションがある場合に設定

`MAIL_CONFIG`  
インスタンスの設定ディレクトリの場所

## CONFIGURATION PARAMETERS

-   **config_directory**  
    ('postconf -d' で確認できる)  
    Postfix における main.cf と master.cf の配置場所

-   **daemon_directory**  
    ('postconf -d' で確認できる)  
    Postfix のサポートプログラムやデーモンプログラムが格納されているディレクトリを指定

-   **import_environment**  
    ('postconf -d' で確認できる)  
    特権を持つ Postfix プロセスが、非 Postfix の親プロセスからインポートする環境変数のリスト、
    または `name=value` 形式の環境変数のオーバーライドを指定  
    環境変数を通じて Postfix プロセスに特定の設定や情報を渡す際に使用

-   **multi_instance_directories** (empty)  
    デフォルト以外の Postfix 設定ディレクトリのオプションリストです。
    これらのディレクトリは追加の Postfix インスタンスに属し、
    デフォルトの Postfix インスタンスと Postfix 実行ファイルおよびドキュメントを共有します。  
    追加インスタンスはデフォルトインスタンスと一緒に開始・停止

-   **multi_instance_group** (empty)  
    Postfix インスタンスのオプションのインスタンスグループ名を指定  
    複数のインスタンスをグループ化し、管理しやすくするために使用

-   **multi_instance_name** (empty)  
    この Postfix インスタンスのオプションのインスタンス名を指定  
    各インスタンスを識別するための名前を設定

-   **multi_instance_enable** (no)  
    この Postfix インスタンスをマルチインスタンスマネージャによって開始・停止などの操作が可能かどうかを指定  
    デフォルト値: `no`  
    特定のインスタンスを管理対象に含めるかどうかを制御

-   **postmulti_start_commands** (start)  
    postmulti インスタンスマネージャが「開始」コマンドとして扱う postfix コマンドを指定します。  
    デフォルト値: `start`  
    インスタンスを開始する際に実行されるコマンドを定義

-   **postmulti_stop_commands**  
    ('postconf -d' で確認できる)  
    postmulti インスタンスマネージャが「停止」コマンドとして扱う postfix コマンドを指定  
    インスタンスを停止する際に実行されるコマンドを定義

-   **postmulti_control_commands** (reload flush)  
    postmulti インスタンスマネージャが「制御」コマンドとして扱う
    postfix コマンド（例: reload, flush）を指定します。  
    これらのコマンドは実行中のインスタンスに対して操作を行います。  
    デフォルト値: `reload flush`

-   **syslog_facility** (mail)  
    Postfix のログ記録に使用する syslog ファシリティを指定  
    デフォルト値: `mail`  
    ログメッセージの分類やフィルタリングを行う際に役立ちます

-   **syslog_name**  
    ('postconf -d' で確認できる)  
    syslog レコード内のプロセス名に付加されるプレフィックスを指定します。
    例えば、"smtpd"が"prefix/smtpd"のようになる  
    ログメッセージをより識別しやすくするために使用

Postfix 3.0 以降で利用可能:

-   **meta_directory** (see 'postconf -d' output)  
    postfix-files, dynamicmaps.cf、および
    マルチインスタンステンプレートファイル（main.cf.proto や master.cf.proto）など、
    複数の Postfix インスタンス間で共有される非実行ファイルの配置場所を指定  
    複数インスタンスで共通して使用される設定やデータファイルを一元管理するために利用

-   **shlib_directory** (see 'postconf -d' output)  
    Postfix のダイナミックリンクライブラリの場所（libpostfix-\*.so）、
    および Postfix データベースプラグイン(postfix-database*plugins*.so)のデフォルトの場所。
    dynamicmaps.cf ファイルに相対パス名を指定します。

### その他

#### FILES

```bash frame=none
$meta_directory/main.cf.proto, stock configuration file
$meta_directory/master.cf.proto, stock configuration file
$daemon_directory/postmulti-script, life-cycle helper program
```

#### AUTHORS

Victor Duchovni
Morgan Stanley

Wietse Venema
IBM T.J. Watson Research
P.O. Box 704
Yorktown Heights, NY 10598, USA

Wietse Venema
Google, Inc.
111 8th Avenue
New York, NY 10011, USA

#### SEE ALSO

postfix(1), Postfix control program
postfix-wrapper(5), Postfix multi-instance API

#### README FILES

Use "postconf readme_directory" or "postconf html_directory" to locate this information.
MULTI_INSTANCE_README, Postfix multi-instance management

#### HISTORY

The postmulti(1) command was introduced with Postfix version 2.6.

#### LICENSE

The Secure Mailer license must be distributed with this software.
